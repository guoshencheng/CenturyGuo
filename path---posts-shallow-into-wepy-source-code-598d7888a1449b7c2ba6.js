webpackJsonp([0x953c5a151f4d],{376:function(n,s){n.exports={data:{markdownRemark:{html:'<blockquote>\n<p>首先让我们先恭喜RNG，其次我们恭喜LGD(data, lol的玩家一个都不能得罪)。wepy是腾讯自家出品的一个小程序框架。小程序在代码体验上会和vue差不多，很多人从vue转向小程序可以说门槛非常低，但是小程序的开发体验我觉得一直是个问题，样式的支持、js语法的支持、<code class="language-text">node_modules</code>不能直接引入等问题，降低了初级开发者的学习成本，却降低了一些从习惯了前端模块化开发的同学对小程序的开发体验。而wepy的正是解决了这个问题。</p>\n</blockquote>\n<p>类vue的框架对于笔者而言其实是有点反感的。笔者是一位vim使用者，但是vim的vue插件真的做的不是特别好，由于我们一般会进行这样的设置<code class="language-text">autocmd BufRead,BufNewFile *.vue setlocal filetype=vue.html.javascript.css</code>，这会在<code class="language-text">*.vue</code>的文件中加载所有<code class="language-text">html.javascript.css</code>的插件，这会导致vim卡顿，而似乎市面上面没有更好的解决方案。当然笔者曾经也用过一段时间的atom，直到atom出现了切换网络就会crash的问题，又用回了vim。说到底vue终究是个门槛低的东西，在人才储备上有比较大的优势，自然也是不学不行。</p>\n<p>几个月前开始接手了一个小程序的项目，当时还没有<code class="language-text">mpvue</code>，面对一家独大的wepy我们选择了尝试，wepy让我们的开发体验提升了不少，但是依然存在了不少问题，有时恨不得直接用小程序原生写。项目进入了平缓的迭代维护期，我们也需要沉下心来研究一下我们开发了两个项目的框架wepy。话在前头，笔者不会像前面几篇一样非常详细的讲述<code class="language-text">wepy</code>的源码，吃不消也没必要。</p>\n<p>虽然再<code class="language-text">packages</code>下的目录很多，但是我们这次只会涉及到这两个包</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">├── wepy\n└── wepy-cli</code></pre>\n      </div>\n<p>其他的包我们这次暂时不会涉及到，大概介绍一下功能，比如<code class="language-text">wepy-ant</code>是一个支付宝小程序的适配器，上面实现了一套和微信小程序wepy几乎一样的wepy接口，用于同构支付宝小程序和微信小程序, 相同的<code class="language-text">wepy-web</code>也是相同的作用，<code class="language-text">wepy-compiler-*</code>都是一些编译器，针对不同的语言进行编译，<code class="language-text">wepy-plugin-*</code>是一些插件，<code class="language-text">compiler</code>和<code class="language-text">plugin</code>本次的源码阅读并没有涉及，两者差不多就是webpack中的loader和plugin。</p>\n<p>那么其实我们这次主要讲的是wepy的api。这里可能描述不清，所谓的wepy的api就是指我们在编写wepy代码的时候用到的api，比如</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> wepy <span class="token keyword">from</span> <span class="token string">\'wepy\'</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DogPage</span> <span class="token keyword">extends</span> <span class="token class-name">wepy<span class="token punctuation">.</span>page</span> <span class="token punctuation">{</span>\n\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>关于wepy-cli这方面的东西这次只会作为辅助作用的涉及，并不会全篇讲述，因为一个wepy的api源码已经内容很多了...</p>\n<h4>wepy的api</h4>\n<blockquote>\n<p>随便瞭一眼出口文件大概输出了这么几个api：<code class="language-text">app</code>、<code class="language-text">event</code>、<code class="language-text">component</code>、<code class="language-text">page</code>、<code class="language-text">mixin</code>、<code class="language-text">$createApp</code>、<code class="language-text">$createPage</code>以及一些工具api</p>\n</blockquote>\n<h5>app</h5>\n<blockquote>\n<p>app对用着小程序的app，我们必不可少的会像这样使用这个api</p>\n</blockquote>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> wepy<span class="token punctuation">.</span>app <span class="token punctuation">{</span>\n  config <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token operator">...</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>在文件的开头，我们会发现wepy定义了一个RequestMQ来处理同时发起超过5个请求在小程序中被限制的问题。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">push</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  param<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mq<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     param<span class="token punctuation">.</span>t <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">this</span><span class="token punctuation">.</span>mq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>param<span class="token punctuation">.</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> param<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mq<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">MAX_REQUEST</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> newone <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mq<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>newone<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> oldComplete <span class="token operator">=</span> obj<span class="token punctuation">.</span>complete<span class="token punctuation">;</span>\n    obj<span class="token punctuation">.</span><span class="token function-variable function">complete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      me<span class="token punctuation">.</span>running<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>running<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">delete</span> me<span class="token punctuation">.</span>map<span class="token punctuation">[</span>obj<span class="token punctuation">.</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      oldComplete <span class="token operator">&amp;&amp;</span> oldComplete<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      me<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token function">request</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  obj <span class="token operator">=</span> obj <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span>url<span class="token punctuation">:</span> obj<span class="token punctuation">}</span> <span class="token punctuation">:</span> obj<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>撇开属性不谈，这个队列一共包含了三个函数，当我们调用<code class="language-text">wx.request</code>的时候，会调用这个队列的request函数，也就是会先执行<code class="language-text">push</code>，然后尝试执行<code class="language-text">next</code>，<code class="language-text">push</code>中，为传入的参数打上一个唯一的时间戳标志，然后将时间戳放置到队列中，并将时间戳和请求的选项在map中映射，在<code class="language-text">next</code>中，会判断等待队列中的任务数量和执行中的任务数量，满足执行中空闲且等待中有任务就会执行请求任务，在执行完毕后递归调用<code class="language-text">next</code>通知队列已经空闲。</p>\n<p>这段代码抽象出来我们能够做成一个任务队列，在很多高并发任务的场景下，我们能够利用这个队列来降低cpu和内存的急性消耗，曾经在一个electron项目中用到过相同的技术，面对用户电脑性能不佳的情况，多个任务同时执行会让用户的电脑边的卡顿，当时笔者就是使用了一个单任务队列来降低用户任务的并发从而降低cpu的消耗。</p>\n<p>app的<code class="language-text">$init</code>函数主要做了两件事：调用了<code class="language-text">$initAPI</code>和将微信小程序的全局getApp()对象赋值给了<code class="language-text">$wxapp</code>。在<code class="language-text">$initAPI</code>中，做的事情也不多，就是将一些微信小程序原生的api进行了替换，request使用了之前提到的队列请求，在api中注入了拦截器，可选的将一些api的回调改为使用promise</p>\n<h5>component</h5>\n<blockquote>\n<p>又是一个我们非常熟悉的api, 当我们申明组件的时候，需要继承这个component</p>\n</blockquote>\n<p>让我们从<code class="language-text">$init</code>开始讲起吧，这个函数接收三个变量<code class="language-text">$wxpage</code>, <code class="language-text">$root</code>和<code class="language-text">$parent</code></p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>$wxpage <span class="token operator">=</span> $wxpage<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$root <span class="token operator">=</span> $root <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">=</span> $parent <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$wxapp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$wxapp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> Props<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>在<code class="language-text">$init</code>函数中，会对当前的一些属性赋值，这里遇到了一个<code class="language-text">Props.build</code>的函数，在文件的上部，已经申明过了</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">build</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> rst <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    rst<span class="token punctuation">[</span>props<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'[object Array]\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>p <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>props<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> <span class="token punctuation">[</span>props<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">]</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>props<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'[object Array]\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> props<span class="token punctuation">[</span>p<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span>\n        rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">\'[object Array]\'</span><span class="token punctuation">)</span>\n        rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token punctuation">[</span>rst<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rst<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>\n      </div>\n<p>简单的解释来说就是你定义props可以分为字符串、字符串数组和对象。处理成一个key对应一个空对象，字符串数组就是把数组中的每个元素按照字符串的方式处理，如果是个对象会将对象的值作出<code class="language-text">value =&gt; { type: [].concat(value) }</code>的映射处理</p>\n<p>最后的props大致可能长这样</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>\n  a<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>\n      defaultValue<span class="token punctuation">:</span> <span class="token number">12121</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  b<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> String\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>然后wepy对<code class="language-text">$props</code>中的<code class="language-text">.sync</code>字段生成一个<code class="language-text">$mappingProps</code>，大致的源码是这样的</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// generate mapping Props</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>binded <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\\.sync$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>binded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// sync goes to mapping</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>binded<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>binded<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>binded<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> binded<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> binded<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>先解释一下<code class="language-text">$props</code>是什么，这个属性在这个文件中是没有赋值的地方的，当我们去cli里面寻找的时候，我们就会发现，这个<code class="language-text">$props</code>是在编译的时候带进来的，我们在写wepy代码的时候假如使用组件，我们会在上面设置一些传递到组件中的属性值，而这个<code class="language-text">$props</code>字段就是组件的实例在template编译的时候总结出来的属性，然后在编译后的代码中，插入到js里面的，所以这里的代码中会出现如此突兀的直接使用<code class="language-text">$props</code>的代码。<code class="language-text">$props</code>大概会长成这样:</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript">$props <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">"search-bar"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"autoFocus"</span><span class="token punctuation">:</span> <span class="token string">"{{auto-focus}}"</span><span class="token punctuation">,</span>\n    <span class="token string">"xmlns:v-on"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n    <span class="token string">"xmlns:v-bind"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n    <span class="token string">"v-bind:keyword.sync"</span><span class="token punctuation">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>\n    <span class="token string">"v-bind:placeholder.once"</span><span class="token punctuation">:</span> <span class="token string">"placeholder"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这是我从某个项目中找到的编译出来的代码片段，用于作为示例，会更好理解最后生成的<code class="language-text">$mappingProps</code>是个什么样的东西，上面的数据经过处理过后<code class="language-text">$mappingProps</code>应该是一个这样的数据</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>\n  <span class="token string">"keyword"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"search-bar"</span><span class="token punctuation">:</span> <span class="token string">"keyword"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>所以，<code class="language-text">$props</code>是当前组件的子组件的xml属性集合，而<code class="language-text">$mappingProps</code>是当前的组件被子组件所使用的属性和使用这个属性的子组件以及其映射属性的关系。</p>\n<p>代码再往下看发现看是处理<code class="language-text">props</code>了，在文章的前面，我们已经解释过<code class="language-text">props</code>的产生以及<code class="language-text">props</code>的大致的数据结构，这边复习一下，<code class="language-text">props</code>大概长这样:</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>\n  a<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>\n      defaultValue<span class="token punctuation">:</span> <span class="token number">12121</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  b<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> String\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>那么我们拿出源码中的代码片段:</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>$parent <span class="token operator">&amp;&amp;</span> $parent<span class="token punctuation">.</span>$props <span class="token operator">&amp;&amp;</span> $parent<span class="token punctuation">.</span>$props<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    val <span class="token operator">=</span> $parent<span class="token punctuation">.</span>$props<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    binded <span class="token operator">=</span> $parent<span class="token punctuation">.</span>$props<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token string">`v-bind:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.once`</span></span><span class="token punctuation">]</span> <span class="token operator">||</span> $parent<span class="token punctuation">.</span>$props<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token string">`v-bind:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.sync`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// ...之后解释</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这里和我们之前讲过的差不多，wepy过滤除了父组件<code class="language-text">props</code>中的，当前组件使用的，需要绑定的属性，从这里我们不难看出，我们在实际编码中也可以像这样的方式<code class="language-text">this.$parent.$props[this.$name]</code>去获取当前这个组件所绑定的数据源，如果这些数据只是一些字符串量的话，我们会轻易的取到，虽然这种使用场景会比较少见，但是也是一个可以储备的hack方式</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>binded<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>binded<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>repeat <span class="token operator">=</span> binded<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">;</span>\n    props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>item <span class="token operator">=</span> binded<span class="token punctuation">.</span>item<span class="token punctuation">;</span>\n    props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> binded<span class="token punctuation">.</span>index<span class="token punctuation">;</span>\n    props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> binded<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n    props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> binded<span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n    inRepeat <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> bindfor <span class="token operator">=</span> binded<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">,</span> binddata <span class="token operator">=</span> $parent<span class="token punctuation">;</span>\n    bindfor<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>t <span class="token operator">=></span> <span class="token punctuation">{</span>\n      binddata <span class="token operator">=</span> binddata <span class="token operator">?</span> binddata<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>binddata <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> binddata <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> binddata <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      repeatKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>binddata<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">\'parent\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      mapping<span class="token punctuation">:</span> binded<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> key\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    val <span class="token operator">=</span> $parent<span class="token punctuation">[</span>binded<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>twoWay<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">\'parent\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> binded<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>value <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 静态传值</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这是后续的一段代码，wepy获取到绑定的父组件属性后，会对当前当前的<code class="language-text">data</code>或者<code class="language-text">$mappingProps</code>作出修改，如果没有绑定父组件的属性，直接将属性的值赋值给<code class="language-text">data</code>中的相同key值，如果binded是一个非对象类型，一般是个字符串，会在父组件获取绑定的变量并赋值给当前组件，如果当前的属性是双向绑定的，wepy会在当前的组件的<code class="language-text">$mappingProps</code>中添加关于父组件的属性绑定关系，所以<code class="language-text">$mappingProps</code>不只是维护关于子组件的属性绑定关系，还维护了父组件的组件绑定关系，大致的结构应该是这样:</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>\n  <span class="token string">"keyword"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"search-bar"</span><span class="token punctuation">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>\n    <span class="token string">"parent"</span><span class="token punctuation">:</span> <span class="token string">"k"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token operator">...</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>如果<code class="language-text">binded</code>是一个对象类型，那么当前这个组件被认为是一个在<code class="language-text">repeat</code>标签里面的组件，这里顺带提一下<code class="language-text">&lt;repeat for=&quot;&quot; item=&quot;&quot; index=&quot;&quot;&gt;&lt;/repeat&gt;</code>会被编译为<code class="language-text">&lt;block wx:for=&quot;&quot; wx:item=&quot;&quot; wx:index=&quot;&quot;&gt;&lt;/block&gt;</code>，如果组件被放置在<code class="language-text">repeat</code>中，会通过for中的表达式，从父组件取到指定的数据，并在当前组件的属性绑定关系中记录当前属性和父组件的绑定关系，这里的绑定关系和非<code class="language-text">repeat</code>的不同，非<code class="language-text">repeat</code>中只需要记录一个父组件的属性的key值，而<code class="language-text">repeat</code>中的组件会记录父组件用于循环的属性key值和当前的key</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>如果定义component的data是一个函数的话，执行这个函数，并赋值给data</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">keyCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    defaultData<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>将生成的<code class="language-text">data</code>的合法key的数据赋值到<code class="language-text">defaultData</code>中</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$copy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>\n      </div>\n<p>将<code class="language-text">data</code>深拷贝到<code class="language-text">$data</code>中</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>inRepeat <span class="token operator">&amp;&amp;</span> repeatKey <span class="token operator">!==</span> undefined<span class="token punctuation">)</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$setIndex</span><span class="token punctuation">(</span>repeatKey<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>\n      </div>\n<p>如果这个组件是在<code class="language-text">repeat</code>中，会更具在组件中的<code class="language-text">index</code>重新获取一下数据，这个index，如果是字符串则是字符的下标，如果是对象，就是key，这里的<code class="language-text">$setIndex</code>的函数就不放出来了，和<code class="language-text">props</code>的处理是有一部分重复的代码的，也去取到了<code class="language-text">binded</code>的数，然后从父组件中提取到index对应的属性，相同的，会对<code class="language-text">this[key]</code>、<code class="language-text">this.data[key]</code>和<code class="language-text">this.$data[key]</code>都进行赋值。在获取<code class="language-text">binded</code>这方面，我觉得是可以从<code class="language-text">this.$mappingProps</code>中获取的，而不是像源码中写到的那样，使用重复的代码去获取。</p>\n<p>下面这段代码是处理computed的</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">keyCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      defaultData<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$copy</span><span class="token punctuation">(</span>defaultData<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>首先这里定义computed一定是一个函数，而不是像vue中那样，可以有<code class="language-text">get()</code>、<code class="language-text">set()</code>的形式，wepy会将所有computed的函数的执行返回值插入到defaultData中，然后再讲defaultData中的值拷贝到当前的组件中</p>\n<p>接下来执行了<code class="language-text">this.setData(defaultData)</code>，那么接下来讲一下<code class="language-text">setData</code>这个函数</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">setData</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n          tmp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>\n          k <span class="token operator">=</span> tmp<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n          tmp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          k <span class="token operator">=</span> tmp<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$wxpage<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">//========分割线</span>\n  <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">\'^\'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$prefix<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\$/g</span><span class="token punctuation">,</span> <span class="token string">\'\\\\$\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'ig\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token keyword">in</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> noPrefix <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>noPrefix<span class="token punctuation">]</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$copy</span><span class="token punctuation">(</span>k<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">isImmutable</span><span class="token punctuation">(</span>k<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      k<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">delete</span> k<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">.</span>$wxpage<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">.</span>$wxpage<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>分割线的前半段处理了只更新一部分值的情况，如果k是一个字符串，也就是说，只更新一个key的值，会将作出<code class="language-text">setData(k, value) =&gt; setData({ [k]: value })</code>的转换，所以我们只关心后半段代码，wepy会读取传入的数据，将数据赋值到<code class="language-text">$data</code>中，最后调用原生的$wxpage对象的<code class="language-text">setData</code>函数来设置属性并更新界面。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">let</span> coms <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>coms<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    coms<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        com<span class="token punctuation">.</span><span class="token function">$init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWxPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p><code class="language-text">$init</code>函数的最后这段代码用于递归的创建当前组件或者<code class="language-text">page</code>的子组件。如此便完成了一个<code class="language-text">$init</code>函数的源码阅读。</p>\n<p>接下来的函数是<code class="language-text">$initMixins()</code>用于初始化<code class="language-text">mixins</code></p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$initMixins</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mixins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mixins<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>mixins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>mixins<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>mixins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>mixins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    inst<span class="token punctuation">.</span><span class="token function">$init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$mixins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>从源码开来，wepy将<code class="language-text">mixins</code>中的构造函数都初始化了一遍，并调用了初始化对象的<code class="language-text">$init</code>函数，并将<code class="language-text">mixin</code>的实例放到了<code class="language-text">$mixins</code>的数组中。如此不如我们先跳过components的源码来看一下mixin的相关部分</p>\n<h5>麻烦让一让，我要插个队 - <code class="language-text">mixins</code></h5>\n<p><code class="language-text">mixins</code>的基类中就定义了一个上述中我们用到的一个<code class="language-text">$init</code>函数，那让我们来看一下这个<code class="language-text">$init</code>函数是干什么的。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$init</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> k<span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> k<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">\'on\'</span> <span class="token operator">&amp;&amp;</span> k <span class="token operator">!==</span> <span class="token string">\'constructor\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> parent<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">[</span><span class="token string">\'data\'</span><span class="token punctuation">,</span> <span class="token string">\'computed\'</span><span class="token punctuation">,</span> <span class="token string">\'events\'</span><span class="token punctuation">,</span> <span class="token string">\'components\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">!==</span> <span class="token string">\'init\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> parent<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>一目了然的就是，<code class="language-text">mixin</code>的<code class="language-text">$init</code>其实就是将所有除了带<code class="language-text">on</code>的属性如果传入的组件或者<code class="language-text">page</code>没有的话，就赋值给它，简单的来说就是属性补充，而<code class="language-text">data</code>, <code class="language-text">computed</code>，<code class="language-text">events</code>，<code class="language-text">components</code>这种，会对这些属性的值做属性的补充。</p>\n<h5>好了又回来了 - <code class="language-text">components</code></h5>\n<p>好了这下我们看完了<code class="language-text">mixin</code>的大致逻辑了，回到<code class="language-text">components</code>，接下来的函数是<code class="language-text">$onLoad</code>。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$onLoad</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mixins<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    mix<span class="token punctuation">[</span><span class="token string">\'onLoad\'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mix<span class="token punctuation">[</span><span class="token string">\'onLoad\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> coms <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>coms<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    coms<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      com<span class="token punctuation">.</span>$onLoad<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>相对于上面的<code class="language-text">$init</code>函数来说，这个函数还有之后的几个都会比较简单，<code class="language-text">$onLoad</code>首先执行了<code class="language-text">mixin</code>中的<code class="language-text">onLoad</code>的函数，然后执行了当前组件或者<code class="language-text">page</code>的<code class="language-text">onLoad</code>函数，最后递归的执行子组件的<code class="language-text">onLoad</code>的函数，而后续的<code class="language-text">$onUnload</code>的执行和<code class="language-text">onLoad</code>的执行方式一样，只是把调用的<code class="language-text">onLoad</code>函数换成了<code class="language-text">onUnload</code>。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">getWxPage</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$wxpage<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">getCurrentPages</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">getCurrentPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这几段代码都很无聊，一起讲了吧。<code class="language-text">getWxPage</code>返回当前的原生微信Page对象，<code class="language-text">getCurrentPages</code>返回当前所有原生微信页面，其实就是调用小程序全局的<code class="language-text">getCurrentPages</code>。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$getComponent</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>com<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>com <span class="token operator">===</span> <span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> path <span class="token operator">=</span> com<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token string">\'\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   \n            com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$root<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">===</span> <span class="token string">\'..\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$getComponent</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          com <span class="token operator">=</span> com<span class="token punctuation">.</span>$com<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> com<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p><code class="language-text">$getComponent</code>用于通过路径获取组件，接收一个<code class="language-text">com</code>的参数，如果<code class="language-text">com</code>是一个数组，直接放回当前组件或者<code class="language-text">page</code>的相同key的子组件，其余按照一定的规则匹配，\'/\'代表根组件，一般为<code class="language-text">page</code>，\'..\'代表上级组件，\'.\'代表当前组件，不带特殊字符的字符串，直接获取所取到的组件或者<code class="language-text">page</code>下的相同key的子组件。当然如果直接传入的就是一个<code class="language-text">component</code>对象，直接会返回</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$invoke</span> <span class="token punctuation">(</span>com<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$getComponent</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>com<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Invalid path: \'</span> <span class="token operator">+</span> com<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">let</span> fn <span class="token operator">=</span> com<span class="token punctuation">.</span>methods <span class="token operator">?</span> com<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> $evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">event</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">\'invoke\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> rst <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>com<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>$evt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    com<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> rst<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    fn <span class="token operator">=</span> com<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>com<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Invalid method: \'</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p><code class="language-text">$invoke</code>这个函数相信大家不会陌生，这是一个官方介绍的函数，<code class="language-text">$invoke</code>首先会根据我们传入的<code class="language-text">com</code>参数调用上面讲到过的<code class="language-text">$getComponent</code>来获取到对应的组件，wepy会首先使用调用组件的methods的函数，如果没有这个函数，才会使用组件的函数，这里我们可以观察到，在使用<code class="language-text">methods</code>中的函数的时候，wepy会构造一个<code class="language-text">event</code>对象，而调用组件函数的时候，并不会传入一个<code class="language-text">event</code>对象。这里既然提及到一个<code class="language-text">event</code>的对象，就让我们先看一下<code class="language-text">event</code>类吧。</p>\n<h5>插播一段广告 - <code class="language-text">event</code>类</h5>\n<p><code class="language-text">wepy</code>使用了一个<code class="language-text">event</code>类来定义事件。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>\n  active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token function">constructor</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> source<span class="token punctuation">,</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>source <span class="token operator">=</span> source<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">$destroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">$transfor</span><span class="token punctuation">(</span>wxevent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> wxevent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> wxevent<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<hr>\n<p>title: \'浅看wepy源码 (wepy 1.7.x)\'\ndate: \'2018-05-23\'</p>\n<hr>\n<p>源码中，<code class="language-text">event</code>会有三个自定义属性，分别是<code class="language-text">name</code>，<code class="language-text">source</code>，<code class="language-text">type</code>，event来的实例可以调用<code class="language-text">$transfor</code>将原生事件中的属性赋值到当前自定义的事件中</p>\n<h5>马上回来 - <code class="language-text">component</code></h5>\n<p>和<code class="language-text">$invoke</code>相似，还有两兄弟，分别是<code class="language-text">$broadcast</code>和<code class="language-text">$emit</code>。接下来会逐个介绍</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$broadcast</span> <span class="token punctuation">(</span>evtName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> $evt <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>evtName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">event</span><span class="token punctuation">(</span>evtName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">\'broadcast\'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> $evt<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span>com<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> $evt<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> current <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">in</span> current<span class="token punctuation">.</span>$com<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      c <span class="token operator">=</span> current<span class="token punctuation">.</span>$com<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">getEventsFn</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> evtName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        c<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>$evt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$evt<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这里并没有使用递归的方式处理事件的向下传递，<code class="language-text">$broadcast</code>函数的功能是对自己的子组件进行事件的广播，并触发组件的组件的事件。这里看到一个陌生的函数<code class="language-text">getEventsFn</code>，先看一下这个函数的实现</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getEventsFn</span> <span class="token punctuation">(</span>comContext<span class="token punctuation">,</span> evtName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fn <span class="token operator">=</span> comContext<span class="token punctuation">.</span>events <span class="token operator">?</span> comContext<span class="token punctuation">.</span>events<span class="token punctuation">[</span>evtName<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>comContext<span class="token punctuation">.</span>$events<span class="token punctuation">[</span>evtName<span class="token punctuation">]</span> <span class="token operator">?</span> comContext<span class="token punctuation">.</span>$events<span class="token punctuation">[</span>evtName<span class="token punctuation">]</span> <span class="token punctuation">:</span> undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> typeFn <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> fnFn<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>typeFn <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果 events[k] 是 string 类型 则认为是调用 methods 上方法</span>\n    <span class="token keyword">const</span> method <span class="token operator">=</span> comContext<span class="token punctuation">.</span>methods <span class="token operator">&amp;&amp;</span> comContext<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      fnFn <span class="token operator">=</span> method<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>typeFn <span class="token operator">===</span> <span class="token string">\'function\'</span> <span class="token operator">||</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fnFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> fnFn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>wepy会优先使用传入的组件events中的event，其次会采用父组件传递给子组件的event，这里有个疑问就是<code class="language-text">$event</code>是什么，这个可以在<code class="language-text">wepy-cli/lib/compile-wpy</code>中找到线索，这是在编译wepy文件的template后解析出这个组件的<code class="language-text">attrs</code>中的事件类型的<code class="language-text">attr</code>，然后通过插入代码的方式注入到组件中的。获取到event之后会判断类型，是函数就返回这个函数，如果不是函数就当做是methods的<code class="language-text">key</code>来获取函数，这里的代码中有个明显的bug，这里的使用<code class="language-text">$events</code>几乎是没有用的，因为<code class="language-text">$events</code>中获取到的是父组件传经来的eventKey，通常是一个字符串，但是如果这个key是一个字符串，wepy往往会使用当前的组件的<code class="language-text">methods[key]</code>的函数。</p>\n<p><code class="language-text">$broadcast</code>还使用了我们熟悉的<code class="language-text">$apply</code>函数，他这里传入了一个函数，可能大家会以为这是一个回调函数，其实不然，让我们看一下源码。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$apply</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$phase<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$$phase <span class="token operator">=</span> <span class="token string">\'$apply\'</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>从这里不难看出，<code class="language-text">$apply(fn)</code>的<code class="language-text">fn</code>参数会比真正执行<code class="language-text">$apply</code>要早一些。所以<code class="language-text">fn</code>只是做一些预处理。这里调用了一个<code class="language-text">$digest</code>函数是做什么的以及我们应该如何设置<code class="language-text">apply</code>的回调，这些我们在解释了<code class="language-text">$digest</code>这个函数之后自然会明白。</p>\n<p>这个函数有点长我们分段解释</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$digest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> k<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> originData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$$phase <span class="token operator">=</span> <span class="token string">\'$digest\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$$dc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$phase<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$$dc<span class="token operator">++</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$dc <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Can not call $apply in $apply process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">let</span> readyToSet <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token operator">...</span>code will show later\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$$phase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$phase <span class="token operator">===</span> <span class="token string">\'$apply\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'$digest\'</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这个函数内部使用了一个while循环，在正常情况下这个while循环只会执行一次，我们在<code class="language-text">$apply()</code>中设置了<code class="language-text">$$phase</code>为<code class="language-text">$apply</code>，在while的最后校验<code class="language-text">$phase</code>的值，最后一般都会将<code class="language-text">false</code>赋值给<code class="language-text">$$phase</code>，因此循环也就不会继续下去了。那么什么时候会出现下一次循环呢，我们先把问题放一放，看一下这个while循环里面的代码，读到中间的若干代码了之后，就会明了了。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// If there are computed property, calculated every times</span>\n    <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> val <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>util<span class="token punctuation">.</span><span class="token function">$isEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Value changed, then send to ReadyToSet</span>\n      readyToSet<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$prefix <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$copy</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这段的代码主要是重新计算<code class="language-text">computed</code>中的数值并赋值到当前组件或者<code class="language-text">page</code>的对象上</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> originData<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>util<span class="token punctuation">.</span><span class="token function">$isEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> originData<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// compare if new data is equal to original data</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> originData<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>watch<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> originData<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    readyToSet<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$prefix <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    originData<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$copy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$repeat <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$repeat<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> $repeat <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$repeat<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>$repeat<span class="token punctuation">.</span>com<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>$repeat<span class="token punctuation">.</span>props<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>$repeat<span class="token punctuation">.</span>com<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">$setIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>$repeat<span class="token punctuation">.</span>com<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> mapping <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$mappingProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>changed<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changed <span class="token operator">===</span> <span class="token string">\'parent\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>util<span class="token punctuation">.</span><span class="token function">$isEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$data<span class="token punctuation">[</span>mapping<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">[</span>mapping<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>data<span class="token punctuation">[</span>mapping<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changed <span class="token operator">!==</span> <span class="token string">\'parent\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>util<span class="token punctuation">.</span><span class="token function">$isEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>changed<span class="token punctuation">]</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>mapping<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>changed<span class="token punctuation">]</span><span class="token punctuation">[</span>mapping<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>changed<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>mapping<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$com<span class="token punctuation">[</span>changed<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>从originData中按照key逐个取值，如果这些key对应的值已经被改过了，则需要调用该key的监听，会优先执行<code class="language-text">watch</code>中的监听，如果<code class="language-text">watch</code>中没有，会尝试调用<code class="language-text">mathods</code>中的同key函数，所以这里可以看出，wepy的watch只有在<code class="language-text">apply</code>之后才会被调用。接着<code class="language-text">digest</code>会通知<code class="language-text">repeat</code>的组件进行更新，然后通知绑定了当前组件的所有组件更新(递归的调用<code class="language-text">$apply</code>)</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readyToSet<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>readyToSet<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> $$nextTick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>$$nextTick<span class="token punctuation">.</span>promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">$$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        $$nextTick<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> $$nextTick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$nextTick<span class="token punctuation">.</span>promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">$$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      $$nextTick<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>这段代码应该才是执行回调函数，在调用了微信小程序原生<code class="language-text">setData</code>的回调后，调用了<code class="language-text">$$nextTick</code>，而这个<code class="language-text">$$nextTick</code>关系到另一个函数的实现<code class="language-text">$nextTick()</code></p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$nextTick</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">\'undefined\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">$$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>$$nextTick <span class="token operator">=</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>调用这个函数会给<code class="language-text">$$nextTick</code>赋值，我们可以传入一个回调函数或者直接处理Promise，不同的是如果使用回调函数的话，我们可以获取到<code class="language-text">this</code>的指向当前的组件或者<code class="language-text">page</code>，那么假如我们在<code class="language-text">$nextTick</code>的使用了<code class="language-text">$apply</code>，那么<code class="language-text">this.$$phase</code>会再次赋值，那么<code class="language-text">while</code>就会继续执行下去，如果嵌套的<code class="language-text">$nextTick</code>次数太多，就会触发<code class="language-text">this.$$dc &gt;= 3</code>的条件，导致报错</p>\n<p>想起来大家应该忘了我们其实本来是在讲<code class="language-text">$broadcast</code>这个函数的，确实扯远了，但是这些也是必须要理解的。</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$emit</span> <span class="token punctuation">(</span>evtName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> com <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> $evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">event</span><span class="token punctuation">(</span>evtName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token string">\'emit\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>$evt<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$events <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$events<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> method <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$events<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">\'v-on:\'</span> <span class="token operator">+</span> evtName<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Invalid method from emit, component is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, method is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Make sure you defined it already.\\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">while</span><span class="token punctuation">(</span>com <span class="token operator">&amp;&amp;</span> com<span class="token punctuation">.</span>$isComponent <span class="token operator">!==</span> undefined <span class="token operator">&amp;&amp;</span> $evt<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> comContext <span class="token operator">=</span> com<span class="token punctuation">;</span>\n      <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">getEventsFn</span><span class="token punctuation">(</span>comContext<span class="token punctuation">,</span> evtName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          comContext<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            fn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>comContext<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          fn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>f <span class="token operator">=></span> <span class="token punctuation">{</span>\n            f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>comContext<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n          comContext<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      com <span class="token operator">=</span> comContext<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p><code class="language-text">$emit</code>首先先定义了一个事件，如果父组件定义了事件就会去父组件的methods查找事件函数，如果查找不到就会报错，如果找到了就会执行并在执行之后调用<code class="language-text">$apply</code>，如果没有查找到父组件的事件定义，就会更具事件名从当前组件开始查找methods中的函数名，查找到了就执行函数并继续向上查找，如此循环直到<code class="language-text">page</code>。</p>\n<p>后面的几个函数<code class="language-text">$on</code>，<code class="language-text">$once</code>，<code class="language-text">$off</code>都是和事件相关的，<code class="language-text">$on</code>就是向<code class="language-text">$event</code>中注册一个事件监听，<code class="language-text">$once</code>只会执行一次，<code class="language-text">$off</code>是移除一个监听</p>\n<p>到此为止，一个component的源码已经不清不楚的讲完了。</p>\n<h5>app 继承于 component</h5>\n<blockquote>\n<p>app是继承与component的，拥有所有的component的函数，执行逻辑也是相同的，这里主要介绍app中特殊定义的一些函数的源码</p>\n</blockquote>\n<p>app定义了两个额外的对象<code class="language-text">$preloadData</code>和<code class="language-text">$prefetchData</code>，先讲一下和<code class="language-text">$preloadData</code>相关的函数</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$preload</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> k<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$preload</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> key<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$preloadData<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>很简单<code class="language-text">$preload</code>为<code class="language-text">$preloadData</code>的对象设置键值对</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token function">$route</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> s <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">\'?\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> k<span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        s <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;`</span></span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    url <span class="token operator">=</span> <span class="token punctuation">{</span>url<span class="token punctuation">:</span> s<span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    params <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$getParams</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// __route__ will be undefined if it called from onLoad</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__route__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__route__ <span class="token operator">=</span> <span class="token function">getCurrentPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__route__<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__wxWebviewId__ <span class="token operator">=</span> <span class="token function">getCurrentPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__wxWebviewId__<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">let</span> absoluteRoute <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__route__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">\'/\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">\'/\'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__route__<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__route__<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> realPath <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">$resolvePath</span><span class="token punctuation">(</span>absoluteRoute<span class="token punctuation">,</span> url<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> goTo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$pages<span class="token punctuation">[</span>realPath<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>goTo <span class="token operator">&amp;&amp;</span> goTo<span class="token punctuation">.</span>onPrefetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> prevPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>__prevPage__<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> preloadData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevPage <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevPage<span class="token punctuation">.</span>$preloadData<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        preloadData <span class="token operator">=</span> prevPage<span class="token punctuation">.</span>$preloadData<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    goTo<span class="token punctuation">.</span>$prefetchData <span class="token operator">=</span> goTo<span class="token punctuation">.</span><span class="token function">onPrefetch</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span> preload<span class="token punctuation">:</span> preloadData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> native<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p><code class="language-text">$route</code>函数先将<code class="language-text">params</code>使用qs的形式拼接到<code class="language-text">url</code>的后面，在跳转页面前，记录当前的<code class="language-text">__route__</code>和<code class="language-text">__wxWebviewId__</code>，通过绝对路径访问即将跳转的page的对象，并尝试调用该<code class="language-text">page</code>的onPrefetch函数，将<code class="language-text">onPrefetch</code>的返回结果赋值给下个页面的<code class="language-text">$prefetchData</code>。然后跳转下个<code class="language-text">page</code>，这里的<code class="language-text">onPrefetch</code>从源码上看起来应该是不能异步的，因为返回值直接赋值给了<code class="language-text">$prefetchData</code></p>\n<p>其余的<code class="language-text">$redirect</code>、<code class="language-text">$navigate</code>、<code class="language-text">$switch</code>都是基于<code class="language-text">$route</code>的，只是最后调用的原生api不同而已A</p>\n<h5>总结</h5>\n<p>这次的wepy源码之旅耗时可以说是比较长的了，关于源码的介绍只是半斤八两，有些地方是没有介绍的，还是需要读者自己有机会去阅读以下。那么这次阅读源码的起因是为了了解一下我们在使用的wepy框架，就让我在最后发表一下比较粗浅的看法。</p>\n<p>这次主要阅读的是wepy的api源码，在api上wepy在帮助用户从使用上尽可能的接近vue，几乎像是实现了一个比较蹩脚的vue框架，在事件的传递上，computed的实现上，都有像vue靠拢，但是始终，还是后很多地方没有做好。当然了，我还没有去mpvue的源码，这里说些话为时尚早，以下关于mpvue和wepy的比较的mpvue部分都纯属猜测和大致阅读文档的感觉。mpvue是直接使用vue的api的，在这点上，mpvue做的更加彻底，从学习成本上，降低了vue使用者使用mpvue开发小程序的成本，从实现上，更加接近vue的良好的api，很多特性wepy因为没有很好的实现所以并没有支持甚至会有难以忍受的bug。</p>\n<p>从编译的角度上来说，wepy自己实现了编译的整个过程，从解析文件到拆分样式模板脚本，到脚本和模板的编译，都是自定义的。而mpvue则是在webpack的基础上，自己写了一些插件和loader来实现编译。wepy从头造轮子的精神让人佩服，而mpvue应该算是踩在巨人的肩膀上，只是踩起来也算是比较费劲了。两者的比较就好像，前者是自己从头造房子并装修，而后者是直接在造好的房子里面装修，前者在造房子的时候会时刻考虑将来的装修，所以在装修的时候就会轻松很多，但是后者只能在别人造的房子里面装修，很多格局都是受限的，但是好在这个房子的制造商确实比较好。mpvue采用webpack为基石我觉得是很智慧的，受限在webpack上写这样的插件和loader是对webpack的插件系统和loader系统要比较了解的，而针对广大已经在大范围使用的webpack的用户而言，会更加熟悉且容易上手，比如很多配置项，即使官方不作出解释，用户也会知道怎么设置，所以官方只需要作出自己核心的loader和插件的配置和说明，而wepy却要维护各方各面，对于开发者、维护者和使用者而言，都会有些痛苦。</p>\n<p>说实话，比较了一段时间的mpvue和wepy之后，对<code class="language-text">mpvue</code>可以说是长草了，最近甚至有计划会对其中的一个小程序作出重构，希望那时候能带来下一篇文章。</p>',
frontmatter:{title:"浅析wepy源码",date:"23 May, 2018",tag:"wepy,小程序"}}},pathContext:{slug:"shallow-into-wepy-source-code"}}}});
//# sourceMappingURL=path---posts-shallow-into-wepy-source-code-598d7888a1449b7c2ba6.js.map