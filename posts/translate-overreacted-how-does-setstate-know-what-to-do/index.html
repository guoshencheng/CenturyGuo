<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style>
/* latin */
@font-face {
  font-family: 'Press Start 2P';
  font-style: normal;
  font-weight: 400;
  src: local('Press Start 2P Regular'), local('PressStart2P-Regular'), url('/static/PressStart2P-Regular.01515575.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215;
}
html {
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-weight: 300;
}
</style><link rel="preload" href="/component---src-layouts-index-js-1c31ac53c9de32dabbbb.js" as="script"/><link rel="preload" href="/component---src-templates-post-js-52cf4b06d22aef3e6b9b.js" as="script"/><link rel="preload" href="/path---posts-translate-overreacted-how-does-setstate-know-what-to-do-10f7ba480c83cbf72c7b.js" as="script"/><link rel="preload" href="/app-67a066bea014415f3b7d.js" as="script"/><link rel="preload" href="/commons-cf32f37b11eea4693204.js" as="script"/><title data-react-helmet="true">Century&#x27;s world</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">.header{font-size:15px;height:50px;overflow:hidden;line-height:50px;box-sizing:border-box;width:100%;padding:0 30px}.header a{color:inherit;text-decoration:none}.header .header-title-container{float:left}.header .header-line-item{font-size:13px;float:right}.markdown-body{color:#4c4c4c;overflow:hidden;font-family:Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;font-size:17px;line-height:1.4;word-wrap:break-word}@media (max-width:480px){.markdown-body{font-size:18px;line-height:1.4}}.markdown-body a{background:transparent}.markdown-body a:active,.markdown-body a:hover{outline:0}.markdown-body strong{font-weight:700}.markdown-body h1{font-size:2em;margin:.67em 0}.markdown-body img{border:0}.markdown-body hr{box-sizing:content-box}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body input{color:inherit;font:inherit;margin:0}.markdown-body html input[disabled]{cursor:default}.markdown-body input{line-height:normal}.markdown-body input[type=checkbox]{box-sizing:border-box;padding:0}.markdown-body table{border-collapse:collapse;border-spacing:0}.markdown-body td,.markdown-body th{padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font:13px/1.4 Helvetica,arial,freesans,clean,sans-serif}.markdown-body a{color:#4183c4;text-decoration:none}.markdown-body a:active,.markdown-body a:focus,.markdown-body a:hover{text-decoration:underline}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border:0;border-bottom:1px solid #ddd}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:15px;margin-bottom:15px;line-height:1.1}.markdown-body h1{font-size:30px}.markdown-body h2{font-size:21px}.markdown-body h3{font-size:16px}.markdown-body h4{font-size:14px}.markdown-body h5{font-size:12px}.markdown-body h6{font-size:11px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:monospace,monospace,source-code-pro,Menlo,Monaco,Consolas,Courier New;font-size:13px;border-radius:8px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body kbd{background-color:#e7e7e7;background-image:linear-gradient(#fefefe,#e7e7e7);background-repeat:repeat-x;border-radius:2px;border:1px solid #cfcfcf;color:#000;padding:3px 5px;line-height:10px;font:11px Consolas,Liberation Mono,Menlo,Courier,monospace;display:inline-block}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body .anchor{position:absolute;top:0;bottom:0;left:0;display:block;padding-right:6px;padding-left:30px;margin-left:-30px}.markdown-body .anchor:focus{outline:none}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:1em;margin-bottom:16px;font-weight:700;line-height:1.4}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{display:none;color:#000;vertical-align:middle}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{height:1em;padding-left:8px;margin-left:-30px;line-height:1;text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{display:inline-block}.markdown-body h1{font-size:2.25em;line-height:1.2}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.75em;line-height:1.225}.markdown-body h3{font-size:1.5em;line-height:1.43}.markdown-body h4{font-size:1.25em}.markdown-body h5{font-size:1em}.markdown-body h6{font-size:1em;color:#777}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:4px;padding:0;margin:16px 0;background-color:#e7e7e7;border:0 none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body blockquote{padding:0 15px;color:#777;border-left:4px solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:border-box}.markdown-body code:after,.markdown-body code:before{letter-spacing:-.2em;content:"\A0"}.markdown-body pre>code{font-size:14px;word-break:normal;white-space:pre;border:0;max-height:200px}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body pre{word-wrap:normal}.markdown-body pre code{word-wrap:normal;border:0}.markdown-body pre code:after,.markdown-body pre code:before{content:normal}.markdown-body .highlight .il,.markdown-body .highlight .m,.markdown-body .highlight .mf,.markdown-body .highlight .mh,.markdown-body .highlight .mi,.markdown-body .highlight .mo{color:#945277}.markdown-body .highlight .s,.markdown-body .highlight .s1,.markdown-body .highlight .s2,.markdown-body .highlight .sb,.markdown-body .highlight .sc,.markdown-body .highlight .sd,.markdown-body .highlight .se,.markdown-body .highlight .sh,.markdown-body .highlight .si,.markdown-body .highlight .sx{color:#df5000}.markdown-body .highlight .k,.markdown-body .highlight .kc,.markdown-body .highlight .kd,.markdown-body .highlight .kn,.markdown-body .highlight .kp,.markdown-body .highlight .kr,.markdown-body .highlight .kt,.markdown-body .highlight .o{font-weight:700}.markdown-body .highlight .kt{color:#458}.markdown-body .highlight .c,.markdown-body .highlight .c1,.markdown-body .highlight .cm{color:#998;font-style:italic}.markdown-body .highlight .cp,.markdown-body .highlight .cs{color:#999;font-weight:700}.markdown-body .highlight .cs{font-style:italic}.markdown-body .highlight .n{color:#4c4c4c}.markdown-body .highlight .na,.markdown-body .highlight .nv,.markdown-body .highlight .vc,.markdown-body .highlight .vg,.markdown-body .highlight .vi{color:teal}.markdown-body .highlight .nb{color:#0086b3}.markdown-body .highlight .nc{color:#458;font-weight:700}.markdown-body .highlight .no{color:#094e99}.markdown-body .highlight .ni{color:purple}.markdown-body .highlight .ne{color:#900;font-weight:700}.markdown-body .highlight .nf{color:#945277;font-weight:700}.markdown-body .highlight .nn{color:#555}.markdown-body .highlight .nt{color:navy}.markdown-body .highlight .err{color:#a61717;background-color:#e3d2d2}.markdown-body .highlight .gd{color:#000;background-color:#fdd}.markdown-body .highlight .gd .x{color:#000;background-color:#faa}.markdown-body .highlight .ge{font-style:italic}.markdown-body .highlight .gr{color:#a00}.markdown-body .highlight .gh{color:#999}.markdown-body .highlight .gi{color:#000;background-color:#dfd}.markdown-body .highlight .gi .x{color:#000;background-color:#afa}.markdown-body .highlight .go{color:#888}.markdown-body .highlight .gp{color:#555}.markdown-body .highlight .gs{font-weight:700}.markdown-body .highlight .gu{color:purple;font-weight:700}.markdown-body .highlight .gt{color:#a00}.markdown-body .highlight .ow{font-weight:700}.markdown-body .highlight .w{color:#bbb}.markdown-body .highlight .sr{color:#017936}.markdown-body .highlight .ss{color:#8b467f}.markdown-body .highlight .bp{color:#999}.markdown-body .highlight .gc{color:#999;background-color:#eaf2f5}.markdown-body .octicon{font:normal normal 16px octicons-anchor;line-height:1;display:inline-block;text-decoration:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .octicon-link:before{content:"\F05C"}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{float:left;margin:.3em 0 .25em -1.6em;vertical-align:middle}html{top:0;position:fixed}body,html{width:100%;height:100%}body{position:absolute;margin:0;font-family:-apple-system,Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;color:#373737}.indie-flow-text{font-family:Indie Flower,Helvetica Neue}.game-text{font-family:Press Start\ 2P,Helvetica Neue}.container{position:absolute;width:100%;bottom:0;left:0;top:0;overflow:auto;-webkit-overflow-scrolling:touch}.container.with-header{top:50px}.posts-list{margin:20px auto;max-width:600px;box-sizing:border-box;padding:0 40px}.posts-list .post-item{margin-bottom:50px}.posts-list .post-item .post-item-title{color:rgba(82,162,96,.9);line-height:1.2;font-size:27px;margin-bottom:10px}.posts-list .post-item .post-item-title a{color:inherit;text-decoration:none}.posts-list .post-item .post-item-base-info{line-height:30px;color:rgba(0,0,0,.3);font-size:13px}.posts-list .post-item .post-item-desc{color:rgba(0,0,0,.6);font-size:15px}@media (max-width:480px){.posts-list{margin:20px auto}.posts-list .post-item{margin-bottom:30px}.posts-list .post-item .post-item-title{color:rgba(82,162,96,.9);line-height:1.2;font-size:27px;margin-bottom:10px}.posts-list .post-item .post-item-title a{color:inherit;text-decoration:none}.posts-list .post-item .post-item-base-info{line-height:30px;color:rgba(0,0,0,.3);font-size:16px}.posts-list .post-item .post-item-desc{color:rgba(0,0,0,.6);font-size:19px}}.post-container{max-width:700px;margin:50px auto;box-sizing:border-box;padding:0 50px}.post-container .post-title{color:rgba(82,162,96,.9);font-size:30px}.post-container .post-date{margin-left:10px;color:rgba(0,0,0,.3)}.post-container .post-tag{color:rgba(82,162,96,.6)}.post-container .post-tag a{margin-left:10px;color:inherit;text-decoration:none}.post-container .post-tag a:hover{color:#52a260}.post-container .markdown-body{margin:30px auto 50px}@media (max-width:480px){.post-container{max-width:1000px;margin:20px auto;padding:0 30px}.post-container .post-title{color:rgba(82,162,96,.9);font-size:30px}.post-container .extra-info{margin-top:10px}.post-container .post-date{margin-left:5px;color:rgba(0,0,0,.3)}.post-container .post-tag{color:rgba(82,162,96,.6)}.post-container .post-tag a{margin-left:10px;color:inherit;text-decoration:none}.post-container .post-tag a:hover{color:#52a260}.post-container .markdown-body{margin:30px auto 50px}}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.mashroom-item{border-radius:5px;margin:.5px;float:left;width:40px;height:40px;background-color:rgba(253,209,14,.6);animation:rotateplane 10s infinite ease-in-out}.mashroom-item.deep{background-color:rgba(253,209,14,.7)}.mashroom-item.blank{animation:none;background:none}@keyframes rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}10%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}60%{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}to{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}}.home-page-container{background:#52a260;position:absolute;left:0;top:0;width:100%;height:100%}.home-page{text-align:center;color:#fff;box-sizing:border-box;overflow:hidden}.home-page .home-title{font-size:35px;margin-bottom:50px}.home-page .mashroom-container{width:328px;margin:0 auto;position:relative;overflow:hidden}.home-page .operations{margin-top:30px}.home-page .operations a{color:#fff;text-decoration:none;margin:0 20px}</style></head><body><div id="___gatsby"><div data-reactroot=""><div class="header"><div class="header-title-container"><div class="header-logo"></div><div class="header-title game-text"><a href="/">Century&#x27;s world</a></div></div><div class="header-line-item game-text header-link"><a href="/">Posts</a></div></div><div class="container with-header"><div class="post-container"><div class="post-title">翻译：setState是如何处理更新的</div><div class="extra-info"><span class="post-date">09 December, 2018</span><span class="post-tag"><a href="/posts/translate">translate</a><a href="/posts/overreacted">overreacted</a></span></div><div class="markdown-body"><div><blockquote>
<p>本文出自<a href="https://overreacted.io/">overreacted</a>，这是<a href="https://mobile.twitter.com/dan_abramov">Dan Abramov</a>写的博客，我觉得对很有用所以特意做了这个翻译<a href="/posts/overreacted">系列</a>，原文链接请查看<a href="https://overreacted.io/how-does-setstate-know-what-to-do/">这里</a></p>
</blockquote>
<p>当你在组件里调用<code class="language-text">setState</code>的时候，你觉得发生了设么？</p>
<div class="gatsby-highlight" data-language="jsx">
      <pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> clicked<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clicked<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clicked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Thanks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
        Click me<span class="token operator">!</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>或许和你想的一样，React 通过接下来的<code class="language-text">{ clicked: true }</code>状态，重新执行了渲染的函数并且将让DOM更新成了<code class="language-text">&lt;h1&gt;Thanks&lt;/h1&gt;</code>元素。</p>
<p>看起来非常简单。那么现在的问题是，究竟是<em>React</em>做了这些？还是<em>React DOM</em>?</p>
<p>更新DOM看起来应该是ReactDOM的职责。但当我们调用<code class="language-text">this.setState()</code>，这却不应该是React DOM的任务。而<code class="language-text">React.Component</code>这个基类的任务则是定义React元素内部的结构。</p>
<p>那么，我们是怎么能够在<code class="language-text">React.Component</code>中调用<code class="language-text">setState()</code>来更新DOM的呢？</p>
<p><strong>放弃的分割线：就想<a href="/trasnlate-overreacted-how-does-react-tell-a-class-from-a-function/">大部分</a><a href="/trasnlate-overreacted-why-do-we-write-super-props/">其他的在这个blog中的</a><a href="/trasnlate-overreacted-why-do-react-elements-have-typeof-property">文章一样</a>。你在生产环境中使用React，你并不需要了解这么多。这篇文章是针对那些想要解开React工作内幕的。是否看下去，完全取决于读者的选择</strong></p>
<hr>
<p>你可能会猜测，是不是<code class="language-text">React.Component</code>这个类包含了更新DOM的逻辑</p>
<p>但是如果是这么做的话，那为什么<code class="language-text">this.setState()</code>能够在这么多的生态中都能使用？比如，React Native应用中的组件也是继承于<code class="language-text">React.Component</code>。在React Native中像上面那样调用<code class="language-text">this.setState()</code>，在Android或者iOS原生的页面上都能够非常正常的运行。</p>
<p>你可能对React对React Test Renderer 或者 Shallow Renderer比较熟悉。这些测试方案让你能够在运行这些测试的时候也能够渲染这些组件。而这些都没有涉及DOM。</p>
<p>如果你使用过其他的渲染器比如<a href="https://github.com/facebook/react/tree/master/packages/react-art">React ART</a>，你就会知道，在同一个页面，我们还能同时使用很多渲染器。(比如说，在ReactDOM的DOM树中渲染ART组件)。这使得全局标志或变量无法维持。</p>
<p>因此 <strong><code class="language-text">React.Component</code>将对于状态的改变的实现委托给了各个平台各自的代码</strong> 在我们能够理解这是怎么做到的之前，我们先研究一下为什么这些包会被分开以及是怎么分开的。</p>
<hr>
<p>这里有个普遍的误区就是大家会觉得React"渲染引擎"是在react的包内的。但这并不是对的。</p>
<p>事实上自从<a href="https://reactjs.org/blog/2015/07/03/react-v0.14-beta-1.html#two-packages">React0.14的包分割</a>，<code class="language-text">react</code>包只用于暴露一些定义组建的API接口。大部分的<em>实现</em>都被放到了"renderer"中</p>
<p><code class="language-text">react-dom</code>, <code class="language-text">react-dom/server</code>, <code class="language-text">react-native</code>, <code class="language-text">react-test-renderer</code>, <code class="language-text">react-art</code>这些都是<code class="language-text">renderer</code>(或者你也可以<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/README.md#practical-examples">编写你自己的</a>)</p>
<p>这就是为什么<code class="language-text">react</code>包不关注你所使用的平台是什么。他所输出的模块，比如<code class="language-text">React.Component</code>，<code class="language-text">React.createElement</code>，<code class="language-text">React.Children</code>这些工具或者<a href="https://reactjs.org/docs/hooks-intro.html">Hooks</a>，都是和目标平台无关的。无论你是使用React DOM或者React DOM Server或者React Native，你都可以把你的组件引入并使用。</p>
<p>相比之下，这些renderer包暴露了平台相关的API，比如 <code class="language-text">ReactDOM.render()</code>让你能够将一个React树渲染到一个DOM节点上。每个renderer都提供了类似的API。通过这种方案，组件就不需要将关于renderer的东西引入了。这让他们更接口化。</p>
<p><strong>众所周知，React的渲染引擎在各个renderer中被实现</strong> 很多renderers在背部包含了一份react内部相同的代码 - 我们把这个叫做<a href="https://github.com/facebook/react/tree/master/packages/react-reconciler">"调节算法"</a>。这些renderer将调节算法和renderer的代码整合成了一个高性能的渲染库。(复制核心的调节算法代码通常会影响最后包的大小，但是对于那些通常只是用一种renderer的开发者来说，还是可以接受的，比如<code class="language-text">react-dom</code>)。</p>
<p><code class="language-text">react</code>赋予你可以使用React的功能，但是不会让你知道他们是怎么实现的。这些renderer(<code class="language-text">react-dom</code>, 'react-native' 等等)完成了React最后渲染和逻辑在各自平台上的实现。他们其中可能有的引用了内部的调节器，然后对于各自的平台，完成相应的实现。</p>
<hr>
<p>现在我们知道为什么<code class="language-text">react</code>和<code class="language-text">react-dom</code>包对于某一个功能都需要更新一个版本。比如，当React 16.3 添加了 Context API之后，React的包就暴露了<code class="language-text">React.createContext()</code>的接口。</p>
<p>但是<code class="language-text">React.createContext()</code>不是React自己实现了context这个功能。具体的实现在React DOM和React DOM Server中是不同的。所以<code class="language-text">createContext()</code>只是返回若干个对象:</p>
<div class="gatsby-highlight" data-language="js">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 做了一点简化</span>
<span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    _currentValue<span class="token punctuation">:</span> defaultValue<span class="token punctuation">,</span>
    Provider<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    Consumer<span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.provider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _context<span class="token punctuation">:</span> context
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>Consumer <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.context'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>当你使用<code class="language-text">&lt;MyContext.Provider&gt;</code> 或者 <code class="language-text">&lt;MyContext.Consumer&gt;</code>的时候，其实是<em>renderer</em>来决定如何处理这些对象。React DOM和React DOM Server各自都会用不同的方式来处理context。</p>
<p><strong>所以当你更新到<code class="language-text">react</code> 16.3+但是你没有跟新<code class="language-text">react-dom</code>的话，你的renderer可能不能够准确的识别<code class="language-text">Provider</code>和<code class="language-text">Consumer</code>的结构</strong> 这也是为什么老版本的<code class="language-text">react-dom</code>可能会<a href="https://stackoverflow.com/a/49677020/458193">不能识别新的context的结构</a></p>
<p>同样的，React Native也有相同的问题。但是不像React DOM，React在更新之后不会立刻强制要求像React Native这样的包更新。这些包拥有自己的更新计划。renderer的更新是在React更新后的几周之内<a href="https://github.com/facebook/react-native/commits/master/Libraries/Renderer/oss">同步更新</a>的。所以React Native和React DOM拥有不同的更新周期。</p>
<hr>
<p>所以我们现在知道<code class="language-text">react</code>包没有什么update的实现，这些实现都被实现在了<code class="language-text">react-dom</code>、<code class="language-text">react-native</code>这些包里面，但这并没有解决我们的问题。<code class="language-text">React.Component</code>的<code class="language-text">setState()</code>是如何和这些renderer交互的。</p>
<p><strong>答案就是每个renderer都给React的实例添加了一个字段</strong> 这个字段被命名为<code class="language-text">updater</code>。这个字段对于开发者来说是没有用的，也不需要去操作，这个字段应该由React DOM，React DOM Server或者React Native来设置，这些renderer会在创建一个React实例的时候创建这个字段:</p>
<div class="gatsby-highlight" data-language="js">
      <pre class="language-js"><code class="language-js"><span class="token comment">// React DOM 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactDOMUpdater<span class="token punctuation">;</span>

<span class="token comment">// React DOM Server 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactDOMServerUpdater<span class="token punctuation">;</span>

<span class="token comment">// React Native 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactNativeUpdater<span class="token punctuation">;</span></code></pre>
      </div>
<p>查看一下<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactBaseClasses.js#L58-L67"><code class="language-text">setState</code>在<code class="language-text">React.Component</code>中的实现</a>，<code class="language-text">setState</code>做的只是将所有的处理交给创建React实例时候的renderer:</p>
<div class="gatsby-highlight" data-language="js">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 简化一下</span>
<span class="token function">setState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用`updater`来调用renderer的逻辑!</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>React DOM Server <a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRenderer.js#L442-L448">可能会</a>忽略state的更新并抛出一个警告，而React DOM 和React Native会让他们的调节器来<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberClassComponent.js#L190-L207">处理</a>state的更新 </p>
<p>这就是为什么<code class="language-text">this.setState()</code>可以更新DOM，即使在React的包中并没有定义如何更新DOM。这个函数会地调用React DOM 添加的<code class="language-text">this.updater</code>的处理方法，并且让React DOM来主持这次更新。</p>
<hr>
<p>我们现在明白了React.Component的类是如何工作的了，那么Hooks又是如何工作的呢？</p>
<p>当开发者看到<a href="https://reactjs.org/docs/hooks-intro.html">Hook 提案 API</a>了之后，可能会疑惑：<code class="language-text">useState</code>又是怎么知道具体应该怎么更新的呢？他们可能会猜想这实现的方式可能会比<code class="language-text">React.Component</code>的<code class="language-text">this.setState()</code>更加"神奇"。</p>
<p>但是从我们现在来看，其实React.Component的<code class="language-text">setState()</code>的实现只是一个空壳。他只是将任务交给了renderer。而其实<code class="language-text">useState</code>Hook<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactHooks.js#L55-L56">做了相同的事情</a></p>
<p><strong>相比于添加了一个<code class="language-text">updater</code>的字段，Hooks添加了一个"dispatcher"的字段</strong> 当你在调用<code class="language-text">React.useState()</code>或者<code class="language-text">React.useEffect()</code>之类的Hook的时候，其实最后会被交给当前的disaptcher来处理。</p>
<div class="gatsby-highlight" data-language="js">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 在 React 中(简化了一下) </span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 真实的属性被藏在更深处，你可以尝试自己找一下</span>
  __currentDispatcher<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>每个renderer会在渲染一个组件之前先设置dispatcher:</p>
<div class="gatsby-highlight" data-language="js">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 在 React DOM中</span>
<span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">React<span class="token punctuation">.</span>__currentDispatcher <span class="token operator">=</span> ReactDOMDispatcher<span class="token punctuation">;</span>
</span><span class="token keyword">let</span> result<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  result <span class="token operator">=</span> <span class="token function">YourComponent</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token comment">// Restore it back</span>
</span><span class="gatsby-highlight-code-line">  React<span class="token punctuation">.</span>__currentDispatcher <span class="token operator">=</span> prevDispatcher<span class="token punctuation">;</span>
</span><span class="token punctuation">}</span></code></pre>
      </div>
<p>比如React DOM Server的实现是<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRendererHooks.js#L340-L354">这样的</a>，而React DOM 和React Native中的调解器实现是<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberHooks.js">这样的</a>。</p>
<p>这也是为什么一些像<code class="language-text">react-dom</code>这样的renderer在使用Hooks的时候需要相同版本的<code class="language-text">react</code>包，否则，你的组件可能不能找到dispatcher!当你使用<a href="https://github.com/facebook/react/issues/13991">不同版本的React</a>的时候，Hook就会不起作用。像这种情况总是会产生一些无法归宿问题的bug，所以Hooks会在这些bug出现之前，强制让你使用相同的React包。</p>
<p>虽然我们不推荐这么做，但是在特定的调试情况下，你也可以自己重写dispatcher。(我之前说的<code class="language-text">__currentDispatcher</code>这个字段不是真实的，你可以通过React仓库自行找出真实的字段)比如 React DevTools就会使用一个特殊的<a href="ttps://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-debug-tools/src/ReactDebugHooks.js#L203-L214">dispatcher</a> 来通过追踪Javascript的调用栈来审查Hooks树。<em>Don’t repeat this at home.</em>(小朋友别乱玩)</p>
<p>这也意味着Hooks并不是强关联React。如果之后会有更多的库来使用这些基本的Hooks，理论上disaptcher会被分到其他的包里面并暴露一个更加友善的API。</p>
<p><code class="language-text">updater</code>和<code class="language-text">__currentDispatcher</code>这两个字段遵循了一个<em>依赖注入</em>的通用编程理念。这两种实现中，renderer将<code class="language-text">setState</code>的实现注入到React的包中，让你的组件可以被方便的定义。</p>
<p>你在使用React的时候并不需要去思考这些。我们希望React的开发者能够花更多的事件在他们的应用代码上，而不是这些抽象的概念，比如 依赖注入。但是如果你曾对<code class="language-text">this.setStete()</code>护着<code class="language-text">useState()</code>是如何工作的非常好奇，这篇文章会帮助到你。</p>
<hr></div></div><div id="disqus_thread"></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-67a066bea014415f3b7d.js","261085952541737":"component---src-pages-posts-js-cd1847220dc74c22455a.js","195351340454287":"component---src-templates-post-js-52cf4b06d22aef3e6b9b.js","162898551421021":"component---src-pages-404-js-be0b53f9f29efb807651.js","35783957827783":"component---src-pages-index-js-75c9bfdbc5a000fa0746.js","60335399758886":"path----372f0b900649fbdd2150.js","52128937219153":"path---posts-静心打磨手中利刃-75e22970e113df097531.js","155720654889932":"path---posts-node-4cccfc101b206ca17060.js","108919453860541":"path---posts-docker-6fc2bd61405dc0eb8dba.js","216240011187204":"path---posts-promise-24939a00160f03be8b63.js","252992580755484":"path---posts-es-f4523effa8af9d0dfdf3.js","34712125554247":"path---posts-react-d74c48d075b3ebb02ef9.js","146831492438712":"path---posts-redux-bcc27fa8abe421ae6204.js","188259988993670":"path---posts-webpack-5494b7a456c009fee78f.js","155243275344959":"path---posts-wepy-3d711b49753e513b4848.js","259481028934733":"path---posts-小程序-5b96c4ba3813aa86cb60.js","202390707485127":"path---posts-translate-7ab39ec64f7af8612e99.js","29362442043640":"path---posts-overreacted-e36ceaade5d42fee7110.js","107370358937462":"path---posts-calm-to-polish-sword-express-fcbe0b2de030d6cc6c98.js","173402839352015":"path---posts-calm-to-polish-sword-ghost-to-passport-89e7ee61784af9f15ea5.js","162685832501665":"path---posts-docker-my-fontend-project-5eef77d637a9e4428a75.js","52675627763808":"path---posts-pre-deep-into-egg-core-ea2d6243ebc713ab582a.js","236054049938401":"path---posts-read-code-es-promise-polyfill-c056fe667c471ad927aa.js","270194815372944":"path---posts-read-react-redux-efaa77f3fc3f05a0d5b2.js","54342248932196":"path---posts-settle-react-es-6-119dbaf4693d20879a2f.js","164086441910093":"path---posts-shallow-into-wepy-source-code-598d7888a1449b7c2ba6.js","9756229565306":"path---posts-translate-overreacted-how-does-react-tell-a-class-from-a-function-1605e86aeffe6e303109.js","226573307014922":"path---posts-translate-overreacted-how-does-setstate-know-what-to-do-10f7ba480c83cbf72c7b.js","39107087938240":"path---posts-translate-overreacted-my-wishlist-for-hot-reloading-606344776afa72a341f7.js","28556145262928":"path---posts-translate-overreacted-optimized-for-change-d7548e279d1bf30e70ea.js","99838320125203":"path---posts-translate-overreacted-why-do-react-elements-have-typeof-property-ec5c99a70765b50265b0.js","60536836248096":"path---posts-translate-overreacted-why-do-we-write-super-props-34c121dcd6ed048ce90e.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-a0e39f21c11f6a62c5ab.js","140933230050240":"path---posts-1de74e8588ef6daf4a36.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-1c31ac53c9de32dabbbb.js"}/*]]>*/</script><script>/*<![CDATA[*/["/commons-cf32f37b11eea4693204.js","/app-67a066bea014415f3b7d.js","/path---posts-translate-overreacted-how-does-setstate-know-what-to-do-10f7ba480c83cbf72c7b.js","/component---src-templates-post-js-52cf4b06d22aef3e6b9b.js","/component---src-layouts-index-js-1c31ac53c9de32dabbbb.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>