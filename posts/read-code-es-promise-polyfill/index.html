<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style>
/* latin */
@font-face {
  font-family: 'Press Start 2P';
  font-style: normal;
  font-weight: 400;
  src: local('Press Start 2P Regular'), local('PressStart2P-Regular'), url('/static/PressStart2P-Regular.01515575.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215;
}
html {
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-weight: 300;
}
</style><link rel="preload" href="/component---src-layouts-index-js-1c31ac53c9de32dabbbb.js" as="script"/><link rel="preload" href="/component---src-templates-post-js-52cf4b06d22aef3e6b9b.js" as="script"/><link rel="preload" href="/path---posts-read-code-es-promise-polyfill-c056fe667c471ad927aa.js" as="script"/><link rel="preload" href="/app-ea00104e203aee2913c7.js" as="script"/><link rel="preload" href="/commons-cf32f37b11eea4693204.js" as="script"/><title data-react-helmet="true">Century&#x27;s world</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">.header{font-size:15px;height:50px;overflow:hidden;line-height:50px;box-sizing:border-box;width:100%;padding:0 30px}.header a{color:inherit;text-decoration:none}.header .header-title-container{float:left}.header .header-line-item{font-size:13px;float:right}.markdown-body{color:#4c4c4c;overflow:hidden;font-family:Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;font-size:17px;line-height:1.4;word-wrap:break-word}@media (max-width:480px){.markdown-body{font-size:18px;line-height:1.4}}.markdown-body a{background:transparent}.markdown-body a:active,.markdown-body a:hover{outline:0}.markdown-body strong{font-weight:700}.markdown-body h1{font-size:2em;margin:.67em 0}.markdown-body img{border:0}.markdown-body hr{box-sizing:content-box}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body input{color:inherit;font:inherit;margin:0}.markdown-body html input[disabled]{cursor:default}.markdown-body input{line-height:normal}.markdown-body input[type=checkbox]{box-sizing:border-box;padding:0}.markdown-body table{border-collapse:collapse;border-spacing:0}.markdown-body td,.markdown-body th{padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font:13px/1.4 Helvetica,arial,freesans,clean,sans-serif}.markdown-body a{color:#4183c4;text-decoration:none}.markdown-body a:active,.markdown-body a:focus,.markdown-body a:hover{text-decoration:underline}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border:0;border-bottom:1px solid #ddd}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:15px;margin-bottom:15px;line-height:1.1}.markdown-body h1{font-size:30px}.markdown-body h2{font-size:21px}.markdown-body h3{font-size:16px}.markdown-body h4{font-size:14px}.markdown-body h5{font-size:12px}.markdown-body h6{font-size:11px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:monospace,monospace,source-code-pro,Menlo,Monaco,Consolas,Courier New;font-size:13px;border-radius:8px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body kbd{background-color:#e7e7e7;background-image:linear-gradient(#fefefe,#e7e7e7);background-repeat:repeat-x;border-radius:2px;border:1px solid #cfcfcf;color:#000;padding:3px 5px;line-height:10px;font:11px Consolas,Liberation Mono,Menlo,Courier,monospace;display:inline-block}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body .anchor{position:absolute;top:0;bottom:0;left:0;display:block;padding-right:6px;padding-left:30px;margin-left:-30px}.markdown-body .anchor:focus{outline:none}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:1em;margin-bottom:16px;font-weight:700;line-height:1.4}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{display:none;color:#000;vertical-align:middle}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{height:1em;padding-left:8px;margin-left:-30px;line-height:1;text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{display:inline-block}.markdown-body h1{font-size:2.25em;line-height:1.2}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.75em;line-height:1.225}.markdown-body h3{font-size:1.5em;line-height:1.43}.markdown-body h4{font-size:1.25em}.markdown-body h5{font-size:1em}.markdown-body h6{font-size:1em;color:#777}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:4px;padding:0;margin:16px 0;background-color:#e7e7e7;border:0 none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body blockquote{padding:0 15px;color:#777;border-left:4px solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:border-box}.markdown-body code:after,.markdown-body code:before{letter-spacing:-.2em;content:"\A0"}.markdown-body pre>code{font-size:14px;word-break:normal;white-space:pre;border:0;max-height:200px}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body pre{word-wrap:normal}.markdown-body pre code{word-wrap:normal;border:0}.markdown-body pre code:after,.markdown-body pre code:before{content:normal}.markdown-body .highlight .il,.markdown-body .highlight .m,.markdown-body .highlight .mf,.markdown-body .highlight .mh,.markdown-body .highlight .mi,.markdown-body .highlight .mo{color:#945277}.markdown-body .highlight .s,.markdown-body .highlight .s1,.markdown-body .highlight .s2,.markdown-body .highlight .sb,.markdown-body .highlight .sc,.markdown-body .highlight .sd,.markdown-body .highlight .se,.markdown-body .highlight .sh,.markdown-body .highlight .si,.markdown-body .highlight .sx{color:#df5000}.markdown-body .highlight .k,.markdown-body .highlight .kc,.markdown-body .highlight .kd,.markdown-body .highlight .kn,.markdown-body .highlight .kp,.markdown-body .highlight .kr,.markdown-body .highlight .kt,.markdown-body .highlight .o{font-weight:700}.markdown-body .highlight .kt{color:#458}.markdown-body .highlight .c,.markdown-body .highlight .c1,.markdown-body .highlight .cm{color:#998;font-style:italic}.markdown-body .highlight .cp,.markdown-body .highlight .cs{color:#999;font-weight:700}.markdown-body .highlight .cs{font-style:italic}.markdown-body .highlight .n{color:#4c4c4c}.markdown-body .highlight .na,.markdown-body .highlight .nv,.markdown-body .highlight .vc,.markdown-body .highlight .vg,.markdown-body .highlight .vi{color:teal}.markdown-body .highlight .nb{color:#0086b3}.markdown-body .highlight .nc{color:#458;font-weight:700}.markdown-body .highlight .no{color:#094e99}.markdown-body .highlight .ni{color:purple}.markdown-body .highlight .ne{color:#900;font-weight:700}.markdown-body .highlight .nf{color:#945277;font-weight:700}.markdown-body .highlight .nn{color:#555}.markdown-body .highlight .nt{color:navy}.markdown-body .highlight .err{color:#a61717;background-color:#e3d2d2}.markdown-body .highlight .gd{color:#000;background-color:#fdd}.markdown-body .highlight .gd .x{color:#000;background-color:#faa}.markdown-body .highlight .ge{font-style:italic}.markdown-body .highlight .gr{color:#a00}.markdown-body .highlight .gh{color:#999}.markdown-body .highlight .gi{color:#000;background-color:#dfd}.markdown-body .highlight .gi .x{color:#000;background-color:#afa}.markdown-body .highlight .go{color:#888}.markdown-body .highlight .gp{color:#555}.markdown-body .highlight .gs{font-weight:700}.markdown-body .highlight .gu{color:purple;font-weight:700}.markdown-body .highlight .gt{color:#a00}.markdown-body .highlight .ow{font-weight:700}.markdown-body .highlight .w{color:#bbb}.markdown-body .highlight .sr{color:#017936}.markdown-body .highlight .ss{color:#8b467f}.markdown-body .highlight .bp{color:#999}.markdown-body .highlight .gc{color:#999;background-color:#eaf2f5}.markdown-body .octicon{font:normal normal 16px octicons-anchor;line-height:1;display:inline-block;text-decoration:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .octicon-link:before{content:"\F05C"}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{float:left;margin:.3em 0 .25em -1.6em;vertical-align:middle}html{top:0;position:fixed}body,html{width:100%;height:100%}body{position:absolute;margin:0;font-family:-apple-system,Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;color:#373737}.indie-flow-text{font-family:Indie Flower,Helvetica Neue}.game-text{font-family:Press Start\ 2P,Helvetica Neue}.container{position:absolute;width:100%;bottom:0;left:0;top:0;overflow:auto;-webkit-overflow-scrolling:touch}.container.with-header{top:50px}.posts-list{margin:20px auto;max-width:600px;box-sizing:border-box;padding:0 40px}.posts-list .post-item{margin-bottom:50px}.posts-list .post-item .post-item-title{color:rgba(82,162,96,.9);line-height:1.2;font-size:27px;margin-bottom:10px}.posts-list .post-item .post-item-title a{color:inherit;text-decoration:none}.posts-list .post-item .post-item-base-info{line-height:30px;color:rgba(0,0,0,.3);font-size:13px}.posts-list .post-item .post-item-desc{color:rgba(0,0,0,.6);font-size:15px}@media (max-width:480px){.posts-list{margin:20px auto}.posts-list .post-item{margin-bottom:30px}.posts-list .post-item .post-item-title{color:rgba(82,162,96,.9);line-height:1.2;font-size:27px;margin-bottom:10px}.posts-list .post-item .post-item-title a{color:inherit;text-decoration:none}.posts-list .post-item .post-item-base-info{line-height:30px;color:rgba(0,0,0,.3);font-size:16px}.posts-list .post-item .post-item-desc{color:rgba(0,0,0,.6);font-size:19px}}.post-container{max-width:700px;margin:50px auto;box-sizing:border-box;padding:0 50px}.post-container .post-title{color:rgba(82,162,96,.9);font-size:30px}.post-container .post-date{margin-left:10px;color:rgba(0,0,0,.3)}.post-container .post-tag{color:rgba(82,162,96,.6)}.post-container .post-tag a{margin-left:10px;color:inherit;text-decoration:none}.post-container .post-tag a:hover{color:#52a260}.post-container .markdown-body{margin:30px auto 50px}@media (max-width:480px){.post-container{max-width:1000px;margin:20px auto;padding:0 30px}.post-container .post-title{color:rgba(82,162,96,.9);font-size:30px}.post-container .extra-info{margin-top:10px}.post-container .post-date{margin-left:5px;color:rgba(0,0,0,.3)}.post-container .post-tag{color:rgba(82,162,96,.6)}.post-container .post-tag a{margin-left:10px;color:inherit;text-decoration:none}.post-container .post-tag a:hover{color:#52a260}.post-container .markdown-body{margin:30px auto 50px}}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.mashroom-item{border-radius:5px;margin:.5px;float:left;width:40px;height:40px;background-color:rgba(253,209,14,.6);animation:rotateplane 10s infinite ease-in-out}.mashroom-item.deep{background-color:rgba(253,209,14,.7)}.mashroom-item.blank{animation:none;background:none}@keyframes rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}10%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}60%{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}to{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}}.home-page-container{background:#52a260;position:absolute;left:0;top:0;width:100%;height:100%}.home-page{text-align:center;color:#fff;box-sizing:border-box;overflow:hidden}.home-page .home-title{font-size:35px;margin-bottom:50px}.home-page .mashroom-container{width:328px;margin:0 auto;position:relative;overflow:hidden}.home-page .operations{margin-top:30px}.home-page .operations a{color:#fff;text-decoration:none;margin:0 20px}</style></head><body><div id="___gatsby"><div data-reactroot=""><div class="header"><div class="header-title-container"><div class="header-logo"></div><div class="header-title game-text"><a href="/">Century&#x27;s world</a></div></div><div class="header-line-item game-text header-link"><a href="/">Posts</a></div></div><div class="container with-header"><div class="post-container"><div class="post-title">尝试理解Promise源码</div><div class="extra-info"><span class="post-date">22 November, 2018</span><span class="post-tag"><a href="/posts/Promise">Promise</a><a href="/posts/ES">ES</a></span></div><div class="markdown-body"><div><blockquote>
<p>Promise 是一个老生常谈的题目，我们总会在前端的题目里多多少少的看到关于Promise的题目，奇怪的是，或许大部分人在日常编码中用的总会得心应手，可最后遇到这方面的题目的时候，总是会手足无措，主要原因可能还是对Promise的理解还不够深入吧，思来想去觉得可以去看一下Promise的补丁的代码，从源码的角度上理解一下Promise。</p>
</blockquote>
<h3>开场白</h3>
<p>我们可以尝试从几个Promise的问题开始。</p>
<ol>
<li>如何终止一个Promise</li>
<li>如上的代码会输出什么?</li>
</ol>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>或许以往的编码经验已经让你得出一个答案了，无论这个答案是否能够是正确的，这并不是最重要的，最重要的是你得出这个答案的原因，如果只是背诵出这个答案或者通过一些介绍的文档让你得到这个答案，都不如因为自己理解这个Promise的工作原理来人让人安心。既然Promise是可以通过类似<a href="">bluebird</a>或者<a href="">es-promise-polyfill</a>patch出来的，那么我们不妨来看看Promise的实现吧。</p>
<p>我们这次主要是阅读<a href="https://github.com/stefanpenner/es6-promise">es5-promise</a>的源码，没有选择bluebird是因为我觉得这个会相对简单点。</p>
<h3>构造函数</h3>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span>resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROMISE_ID</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_state <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>noop <span class="token operator">!==</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">typeof</span> resolver <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">needsResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span> <span class="token operator">?</span> <span class="token function">initializePromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">needsNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>构造函数中为一个promise的实例初始化了一些属性，需要注意的是一个<code class="language-text">promise</code>的实例在初始化的时候状态是<code class="language-text">undefined</code>，我们可以查看一下promise定义的状态</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">PENDING</span>   <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span>  <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>我们需要记住这个状态的定义，在后续阅读源码的时候会有用。</p>
<p>除此之外<code class="language-text">promise</code>的初始化还创建了一个<code class="language-text">_subscribers</code>的属性，这个在整个<code class="language-text">promise</code>的运作过程中很重要，后续会提到。</p>
<p>在检查了resolve和该函数是否被当做构造函数使用之后，执行了<code class="language-text">initializePromise</code>函数来继续初始化<code class="language-text">promise</code>，之后的大部分逻辑都放在了<code class="language-text">-internal.js</code>的文件中</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">initializePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这里的promise是构造函数生成的promise实例，这里的resolver指的是我们在创建Promise实例时传入的函数，比如</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
      </div>
<p>上述例子中 resolver指的就是<code class="language-text">(resolve, reject) =&gt; {}</code>，我们调用的<code class="language-text">resolve(value)</code>相当于调用了内部定义的<code class="language-text">resolve(promise, value)</code>，我们调用<code class="language-text">reject(reason)</code>相当于调用了内部定义的<code class="language-text">reject(promise, reason)</code>。因此可以看出，当我们创建了一个<code class="language-text">Promise</code>之后，<code class="language-text">Promise</code>的<code class="language-text">resolver</code>会直接开始运行。</p>
<p>那么接下来让我们看一下<code class="language-text">resolve(promise, value)</code>的实现</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token function">selfFulfillment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">objectOrFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleMaybeThenable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">getThen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>首先来看第一个判断，这个判断检查了当前的<code class="language-text">promise</code>是否和<code class="language-text">resolve</code>的<code class="language-text">value</code>是相同的，如果相同则执行<code class="language-text">reject</code>，关于 reject 我们可以稍后再来讲解，但是大致是一个跑出异常的途径，而<code class="language-text">selfFulfillment</code>则返回一个错误</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">selfFulfillment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"You cannot resolve a promise with itself"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>也就是说，在promise和resolve的value相同的情况下，会返回一个异常，比如</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise reject with type error</span></code></pre>
      </div>
<p>这点和原生的Promise可能会有点出入，原生的<code class="language-text">Promise</code>在执行上述第一行后会向外抛出一个异常，而且异常描述和<code class="language-text">es-promise</code>不同，原生异常描述为<code class="language-text">Chaining cycle detected for promise #&lt;Promise&gt;</code> 但是其实应该是一个意思。</p>
<p>接着下一个判断<code class="language-text">objectOrFunction(value)</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">objectOrFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> x<span class="token punctuation">;</span>
  <span class="token keyword">return</span> x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这是一个简单的判断是否为对象挥着函数的方法能够通过校验的有 <code class="language-text">函数、纯对象、数组、类</code></p>
<p>接着如果是个对象或者函数的话，执行一个<code class="language-text">handleMaybeThenable</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleMaybeThenable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> maybeThenable<span class="token punctuation">,</span> then<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>maybeThenable<span class="token punctuation">.</span>constructor <span class="token operator">===</span> promise<span class="token punctuation">.</span>constructor <span class="token operator">&amp;&amp;</span>
      then <span class="token operator">===</span> originalThen <span class="token operator">&amp;&amp;</span>
      maybeThenable<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>resolve <span class="token operator">===</span> originalResolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleOwnThenable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> maybeThenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>then <span class="token operator">===</span> <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>then <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> maybeThenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleForeignThenable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> maybeThenable<span class="token punctuation">,</span> then<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> maybeThenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这里先解释一下入参，<code class="language-text">promise</code>是当前的promise，<code class="language-text">maybeThenable</code>是<code class="language-text">resolve</code>的<code class="language-text">value</code>且这个value是对象或者函数，<code class="language-text">then</code>是通过一个<code class="language-text">getThen(value)</code>的函数来获取的</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getThen</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这个函数尝试获取了promise的then属性、这里的try/catch我不是很看得懂，应该只有一部分开发人员实在作死的情况下才能够抛出异常。</p>
<p>那么三个入参已经解释完了，我们首先来看第一个判断</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">maybeThenable<span class="token punctuation">.</span>constructor <span class="token operator">===</span> promise<span class="token punctuation">.</span>constructor
<span class="token operator">&amp;&amp;</span> then <span class="token operator">===</span> originalThen
<span class="token operator">&amp;&amp;</span> maybeThenable<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>resolve <span class="token operator">===</span> originalResolve</code></pre>
      </div>
<p>总的来说，先判断了当前resolve的value是否是一个promise的实例，然后判断value.then是否是一个正常的then(和定义的promise的then函数相同)，通过这个判断就能够确定当前的value就是一个正常的<code class="language-text">promise</code>实例</p>
<p>针对返回的<code class="language-text">promise</code>会调用函数<code class="language-text">handleOwnThenable</code>来处理</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleOwnThenable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> thenable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>thenable<span class="token punctuation">.</span>_state <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> thenable<span class="token punctuation">.</span>_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>thenable<span class="token punctuation">.</span>_state <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> thenable<span class="token punctuation">.</span>_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">subscribe</span><span class="token punctuation">(</span>thenable<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> value  <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   reason <span class="token operator">=></span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这里的promise和thenable分别是当前的promise对象和resolve的value，而thenable其实经过判断也是一个合法的promise，这里校验了resolve的promise的<code class="language-text">_state</code>。</p>
<p>如果thenable是一个已经完成的<code class="language-text">promise</code>的话，调用<code class="language-text">fullfill()</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  promise<span class="token punctuation">.</span>_result <span class="token operator">=</span> value<span class="token punctuation">;</span>
  promise<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_subscribers<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">asap</span><span class="token punctuation">(</span>publish<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>再次介绍一下这里的入参，promise是当前的promise实例，value是resolve的promise在fulfill之后的返回值，首先<code class="language-text">fullfill</code>本身也会校验<code class="language-text">promise</code>的状态，然后将当前的promise实例赋值状态和当前的值。后续去判断了一个<code class="language-text">promise._subscribers</code>的长度，关于这个<code class="language-text">promise._subscribers</code>应该只是这个<code class="language-text">es-promise</code>自己实现的需要，原生的<code class="language-text">promise</code>是没有这个属性的，我们没有去关注原生的promise的实现方式，暂且关系这个<code class="language-text">es-promise</code>的实现吧，而这个<code class="language-text">promise._subscribers</code>在后续会讲到，可以先理解为一系列已经注册的观察者。至于这些观察者是什么时候注册，后续会娓娓道来。那么我们现在可能比较关心的就是如何理解<code class="language-text">asap(publish, promise)</code>这个调用</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">var</span> <span class="token function-variable function">asap</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">asap</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  queue<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  queue<span class="token punctuation">[</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arg<span class="token punctuation">;</span>
  len <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If len is 2, that means that we need to schedule an async flush.</span>
    <span class="token comment">// If additional callbacks are queued before the queue is flushed, they</span>
    <span class="token comment">// will be processed by this flush that we are scheduling.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>customSchedulerFn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">customSchedulerFn</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">scheduleFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p><code class="language-text">queue</code>是一个全局的变量，每次执行asap都会将回调函数callback和该回调函数所需的参数arg放到队列<code class="language-text">queue</code>中，而len记录了当前queue的长度，当长度为2，也就是说，本来队列中为空的情况下会去执行<code class="language-text">scheduleFlush()</code>这里有个判断，会判断<code class="language-text">customSchedulerFn</code>这个变量，这个变量会在开发人员调用了<code class="language-text">setScheduler</code>设置成开发人员自定义的<code class="language-text">scheduleFlush</code>，而系统已经更具浏览器的兼容情况为我们提供了<code class="language-text">scheduleFlush</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">let</span> scheduleFlush<span class="token punctuation">;</span>
<span class="token comment">// Decide what async method to use to triggering processing of queued callbacks:</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduleFlush <span class="token operator">=</span> <span class="token function">useNextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>BrowserMutationObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduleFlush <span class="token operator">=</span> <span class="token function">useMutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduleFlush <span class="token operator">=</span> <span class="token function">useMessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>browserWindow <span class="token operator">===</span> undefined <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> require <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduleFlush <span class="token operator">=</span> <span class="token function">attemptVertx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  scheduleFlush <span class="token operator">=</span> <span class="token function">useSetTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>我们先看<code class="language-text">isNode</code>的情况</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">useNextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>可以发现，其实scheduleFlush就是想在下一个事件循环中执行flush的操作。</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arg <span class="token operator">=</span> queue<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
    queue<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>而flush就是讲队列中的任务逐个执行，这里没有将队列中的数据排出，这就是为什么还需要个len来表示当前队列的实际长度</p>
<p>接下来的各种判断就是根据浏览器来决定用什么方式来实现“下个事件循环”中执行</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">useMutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> iterations <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserMutationObserver</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token punctuation">{</span> characterData<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>iterations <span class="token operator">=</span> <span class="token operator">++</span>iterations <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p><code class="language-text">useMutationObserver</code>是通过MutationObserver的监听来实现事件循环，关于MutationObserver的浏览器兼容问题，可以查看<a href="https://caniuse.com/#search=MutationObserver">can i use </a></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// web worker</span>
<span class="token keyword">function</span> <span class="token function">useMessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> flush<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p><code class="language-text">useMessageChannel</code>是通过web worker的<code class="language-text">MessageChannel</code>来实现事件循环的，关于<code class="language-text">MessageChannel</code>的浏览器兼容问题，可以查看<a href="https://caniuse.com/#search=MessageChannel">can i use</a></p>
<p>最后，保底会使用setTimeout来实现事件循环</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">useSetTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> globalSetTimeout <span class="token operator">=</span> setTimeout<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">globalSetTimeout</span><span class="token punctuation">(</span>flush<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>当然这并不是很科学的下个事件循环的实现，只是模拟的一个简短的延迟执行。</p>
<p>回过头来我们继续看调用这个<code class="language-text">asap</code>的代码</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
    <span class="token function">asap</span><span class="token punctuation">(</span>publish<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>通过查看刚才对<code class="language-text">asap</code>这个函数的立即，上述代码可以理解为下个事件循环执行<code class="language-text">publish(promise)</code>函数，那么再看查看一下<code class="language-text">publish(promise)</code>这个函数</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">publish</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> subscribers <span class="token operator">=</span> promise<span class="token punctuation">.</span>_subscribers<span class="token punctuation">;</span>
  <span class="token keyword">let</span> settled <span class="token operator">=</span> promise<span class="token punctuation">.</span>_state<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">let</span> child<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> detail <span class="token operator">=</span> promise<span class="token punctuation">.</span>_result<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subscribers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child <span class="token operator">=</span> subscribers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    callback <span class="token operator">=</span> subscribers<span class="token punctuation">[</span>i <span class="token operator">+</span> settled<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invokeCallback</span><span class="token punctuation">(</span>settled<span class="token punctuation">,</span> child<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  promise<span class="token punctuation">.</span>_subscribers<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>publish获取了promise的subscribers，subscribers中的数据是循环的使用<code class="language-text">[...&lt;promise&gt;, &lt;resolved callback&gt;, &lt;rejected callback&gt;...]</code> 如果 subscribers 中没有观察者，则什么都不做，否则循环。在每个循环中，取到观察者promise，通过当前的promise的状态来获取应该使用resolve还是reject</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">callback <span class="token operator">=</span> subscribers<span class="token punctuation">[</span>i <span class="token operator">+</span> settled<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>由于<code class="language-text">es-promise</code>对state的定义为:</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">PENDING</span>   <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span>  <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>所以可以直接通过<code class="language-text">subscribers[i + settled]</code>来获取到当前的callback, 获取到callback之后会校验观察者的promise是否存在，如果存在就调用<code class="language-text">invokeCallback</code>，否则就调用<code class="language-text">callback(detail)</code>，相当于直接调用注册的的resolve或者reject的回调，<code class="language-text">callback(detail)</code>这个很好理解，那么我们再看看<code class="language-text">invokeCallback</code>做了什么</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">invokeCallback</span><span class="token punctuation">(</span>settled<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> detail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hasCallback <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">,</span>
      value<span class="token punctuation">,</span> error<span class="token punctuation">,</span> succeeded<span class="token punctuation">,</span> failed<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token function">tryCatch</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token constant">TRY_CATCH_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      error <span class="token operator">=</span> value<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
      value<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      succeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token function">cannotReturnOwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> detail<span class="token punctuation">;</span>
    succeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// noop</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCallback <span class="token operator">&amp;&amp;</span> succeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>settled <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fulfill</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>settled <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这又是一个需要回顾入参的函数，settled为当前Promise的状态，promise为当前的观察的promise的实例，callback为当前观察者注册的父promise在resolve或者reject后的回调，detail是当前promise在fullfill后的返回值，首先会校验是否callback是否为一个函数，如果是一个函数，会尝试执行这个函数，那么可能我们就要关心一个这个函数到底是什么东西，也是时候讲述一下这写subscriber是什么时候注册的了，在之前的代码中我们已经看到过一次注册的地方了，在<code class="language-text">handleOwnThenable</code>中如果当前的promise为pedding的状态的话会执行<code class="language-text">subscribe(thenable, undefined, value  =&gt; resolve(promise, value), reason =&gt; reject(promise, reason))</code>，可以看一下<code class="language-text">subscribe</code>的实现</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">,</span> onFulfillment<span class="token punctuation">,</span> onRejection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> _subscribers <span class="token punctuation">}</span> <span class="token operator">=</span> parent<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> _subscribers<span class="token punctuation">;</span>
  parent<span class="token punctuation">.</span>_onerror <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  _subscribers<span class="token punctuation">[</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token punctuation">;</span>
  _subscribers<span class="token punctuation">[</span>length <span class="token operator">+</span> <span class="token constant">FULFILLED</span><span class="token punctuation">]</span> <span class="token operator">=</span> onFulfillment<span class="token punctuation">;</span>
  _subscribers<span class="token punctuation">[</span>length <span class="token operator">+</span> <span class="token constant">REJECTED</span><span class="token punctuation">]</span>  <span class="token operator">=</span> onRejection<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">asap</span><span class="token punctuation">(</span>publish<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>subscribe在当前promise的_subscribers中插入观察者信息（promise、resolve、reject），判断当前的<code class="language-text">promise</code>如果为非pedding状态且之前观察者队列为空的话，可以直接在下个事件循环中，通知所有的观察者当前的promise已经完成，并执行回调。回看<code class="language-text">invokeCallback</code>的callback应该就是<code class="language-text">subscribe</code>的<code class="language-text">onFullfillment</code>或者<code class="language-text">onRejection</code>，这个参数是在调用<code class="language-text">subscribe</code>的时候传入的，<code class="language-text">handleOwnThenable</code>中最后就是调用了<code class="language-text">resolve(promise, value)</code>和<code class="language-text">reject(promise, error)</code>来作为<code class="language-text">onFullfillment</code>和<code class="language-text">onRejection</code>。当然之前的<code class="language-text">handleOwnThenable</code>中调用的<code class="language-text">subscribe</code>显然不会走到<code class="language-text">invokeCallback</code>的逻辑中，因为那个<code class="language-text">subscribe</code>的child是空的，最后在publish的时候<code class="language-text">child</code>为空会直接执行<code class="language-text">callback(detail)</code>，那么什么时候执行<code class="language-text">invokeCallback</code>呢，可以查看一下还有什么地方会调用<code class="language-text">subscribe</code>。</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">then</span><span class="token punctuation">(</span>onFulfillment<span class="token punctuation">,</span> onRejection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>cnstructor</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">[</span><span class="token constant">PROMISE_ID</span><span class="token punctuation">]</span> <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">makePromise</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> _state <span class="token punctuation">}</span> <span class="token operator">=</span> parent<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_state <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">asap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">invokeCallback</span><span class="token punctuation">(</span>_state<span class="token punctuation">,</span> child<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">subscribe</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">,</span> onFulfillment<span class="token punctuation">,</span> onRejection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>可以看到 Promise.prototype.then 是如上实现的，每个promise.then都会创建一个新的<code class="language-text">promise</code>，并且在then执行结束的时候返回它，如果当前promise的状态还处于pendding会注册一个监听，这个监听在当前promise完成之后会执行传入onFulfillment或者onRejection，不然会直接在下个事件循环中执行onFulfillment和onRejection，这里的subscribe会传入一个child，所以会在最后执行publish的时候执行invokeCallback</p>
<p>所以总的来说，invokeCallback执行的一般可能是then的时候onFulfillment或onRejection，或者可能是创建一个Promise的时候resolve一个新的promise的时候</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// example1</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 这里的then会注册一个subscribe然后会触发invokeCallback，callback参数为() => 1</span>
<span class="token comment">// example2</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 因为resolve了一个promise，会subscribe这个resolve的promise，在这个promise结束的时候，改变自身的状态并且尝试publish自己的所有subscribers</span></code></pre>
      </div>
<p>回到开始的<code class="language-text">initializePromise</code>，我们解释了一大圈resolve的逻辑，现在再看看reject的逻辑</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  promise<span class="token punctuation">.</span>_state <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
  promise<span class="token punctuation">.</span>_result <span class="token operator">=</span> reason<span class="token punctuation">;</span>
  <span class="token function">asap</span><span class="token punctuation">(</span>publishRejection<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>其实reject的逻辑很简单，就是讲当前的promise的状态设置rejected并赋值相应的原因，在下个事件循环中调用<code class="language-text">publishRejection</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">publishRejection</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_onerror<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    promise<span class="token punctuation">.</span><span class="token function">_onerror</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">publish</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p><code class="language-text">publishRejection</code>的实现其实只是在正常的publish之前尝试调用了<code class="language-text">promise._onerror</code>，我不知道这个是不是原生promise的标准，这个<code class="language-text">es-promise</code>是存在这个逻辑的。</p></div></div><div id="disqus_thread"></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-ea00104e203aee2913c7.js","261085952541737":"component---src-pages-posts-js-cd1847220dc74c22455a.js","195351340454287":"component---src-templates-post-js-52cf4b06d22aef3e6b9b.js","162898551421021":"component---src-pages-404-js-be0b53f9f29efb807651.js","35783957827783":"component---src-pages-index-js-75c9bfdbc5a000fa0746.js","60335399758886":"path----372f0b900649fbdd2150.js","52128937219153":"path---posts-静心打磨手中利刃-75e22970e113df097531.js","155720654889932":"path---posts-node-ccbb92ba6061df419487.js","108919453860541":"path---posts-docker-6fc2bd61405dc0eb8dba.js","216240011187204":"path---posts-promise-24939a00160f03be8b63.js","252992580755484":"path---posts-es-f4523effa8af9d0dfdf3.js","34712125554247":"path---posts-react-d74c48d075b3ebb02ef9.js","146831492438712":"path---posts-redux-bcc27fa8abe421ae6204.js","188259988993670":"path---posts-webpack-5494b7a456c009fee78f.js","155243275344959":"path---posts-wepy-3d711b49753e513b4848.js","259481028934733":"path---posts-小程序-5b96c4ba3813aa86cb60.js","202390707485127":"path---posts-translate-7ab39ec64f7af8612e99.js","29362442043640":"path---posts-overreacted-e36ceaade5d42fee7110.js","207623064873009":"path---posts-egg-64e66c4dab9b58857bbc.js","107370358937462":"path---posts-calm-to-polish-sword-express-fcbe0b2de030d6cc6c98.js","173402839352015":"path---posts-calm-to-polish-sword-ghost-to-passport-89e7ee61784af9f15ea5.js","162685832501665":"path---posts-docker-my-fontend-project-5eef77d637a9e4428a75.js","52675627763808":"path---posts-pre-deep-into-egg-core-597f50e01ddde2bce481.js","236054049938401":"path---posts-read-code-es-promise-polyfill-c056fe667c471ad927aa.js","270194815372944":"path---posts-read-react-redux-efaa77f3fc3f05a0d5b2.js","54342248932196":"path---posts-settle-react-es-6-119dbaf4693d20879a2f.js","164086441910093":"path---posts-shallow-into-wepy-source-code-598d7888a1449b7c2ba6.js","9756229565306":"path---posts-translate-overreacted-how-does-react-tell-a-class-from-a-function-1605e86aeffe6e303109.js","226573307014922":"path---posts-translate-overreacted-how-does-setstate-know-what-to-do-10f7ba480c83cbf72c7b.js","39107087938240":"path---posts-translate-overreacted-my-wishlist-for-hot-reloading-606344776afa72a341f7.js","28556145262928":"path---posts-translate-overreacted-optimized-for-change-d7548e279d1bf30e70ea.js","99838320125203":"path---posts-translate-overreacted-why-do-react-elements-have-typeof-property-ec5c99a70765b50265b0.js","60536836248096":"path---posts-translate-overreacted-why-do-we-write-super-props-34c121dcd6ed048ce90e.js","16827927261308":"path---posts-what-make-rules-of-directory-for-egg-project-e067a4385ed491f77eb4.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-a0e39f21c11f6a62c5ab.js","140933230050240":"path---posts-b94196abe63b5f9e8cd5.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-1c31ac53c9de32dabbbb.js"}/*]]>*/</script><script>/*<![CDATA[*/["/commons-cf32f37b11eea4693204.js","/app-ea00104e203aee2913c7.js","/path---posts-read-code-es-promise-polyfill-c056fe667c471ad927aa.js","/component---src-templates-post-js-52cf4b06d22aef3e6b9b.js","/component---src-layouts-index-js-1c31ac53c9de32dabbbb.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>