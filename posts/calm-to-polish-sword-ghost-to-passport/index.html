<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style>
/* latin */
@font-face {
  font-family: 'Press Start 2P';
  font-style: normal;
  font-weight: 400;
  src: local('Press Start 2P Regular'), local('PressStart2P-Regular'), url('/static/PressStart2P-Regular.01515575.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215;
}
html {
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
}
</style><link rel="preload" href="/component---src-layouts-index-js-5fa57a956833cc6431c9.js" as="script"/><link rel="preload" href="/component---src-templates-post-js-151fda6e99914a23c475.js" as="script"/><link rel="preload" href="/path---posts-calm-to-polish-sword-ghost-to-passport-89e7ee61784af9f15ea5.js" as="script"/><link rel="preload" href="/app-3753e803ea1a9abe3edc.js" as="script"/><link rel="preload" href="/commons-cf32f37b11eea4693204.js" as="script"/><title data-react-helmet="true">Century&#x27;s world</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">.header{font-size:15px;height:50px;overflow:hidden;line-height:50px;box-sizing:border-box;width:100%;padding:0 30px}.header a{color:inherit;text-decoration:none}.header .header-title-container{float:left}.header .header-line-item{font-size:13px;float:right}.markdown-body{color:#4c4c4c;overflow:hidden;font-family:Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;font-size:15px;line-height:1.6;word-wrap:break-word}.markdown-body a{background:transparent}.markdown-body a:active,.markdown-body a:hover{outline:0}.markdown-body strong{font-weight:700}.markdown-body h1{font-size:2em;margin:.67em 0}.markdown-body img{border:0}.markdown-body hr{box-sizing:content-box}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body input{color:inherit;font:inherit;margin:0}.markdown-body html input[disabled]{cursor:default}.markdown-body input{line-height:normal}.markdown-body input[type=checkbox]{box-sizing:border-box;padding:0}.markdown-body table{border-collapse:collapse;border-spacing:0}.markdown-body td,.markdown-body th{padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font:13px/1.4 Helvetica,arial,freesans,clean,sans-serif}.markdown-body a{color:#4183c4;text-decoration:none}.markdown-body a:active,.markdown-body a:focus,.markdown-body a:hover{text-decoration:underline}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border:0;border-bottom:1px solid #ddd}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:15px;margin-bottom:15px;line-height:1.1}.markdown-body h1{font-size:30px}.markdown-body h2{font-size:21px}.markdown-body h3{font-size:16px}.markdown-body h4{font-size:14px}.markdown-body h5{font-size:12px}.markdown-body h6{font-size:11px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:monospace,monospace,source-code-pro,Menlo,Monaco,Consolas,Courier New;font-size:13px;border-radius:8px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body kbd{background-color:#e7e7e7;background-image:linear-gradient(#fefefe,#e7e7e7);background-repeat:repeat-x;border-radius:2px;border:1px solid #cfcfcf;color:#000;padding:3px 5px;line-height:10px;font:11px Consolas,Liberation Mono,Menlo,Courier,monospace;display:inline-block}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body .anchor{position:absolute;top:0;bottom:0;left:0;display:block;padding-right:6px;padding-left:30px;margin-left:-30px}.markdown-body .anchor:focus{outline:none}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:1em;margin-bottom:16px;font-weight:700;line-height:1.4}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{display:none;color:#000;vertical-align:middle}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{height:1em;padding-left:8px;margin-left:-30px;line-height:1;text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{display:inline-block}.markdown-body h1{font-size:2.25em;line-height:1.2}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.75em;line-height:1.225}.markdown-body h3{font-size:1.5em;line-height:1.43}.markdown-body h4{font-size:1.25em}.markdown-body h5{font-size:1em}.markdown-body h6{font-size:1em;color:#777}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:4px;padding:0;margin:16px 0;background-color:#e7e7e7;border:0 none}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body blockquote{padding:0 15px;color:#777;border-left:4px solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:border-box}.markdown-body code:after,.markdown-body code:before{letter-spacing:-.2em;content:"\A0"}.markdown-body pre>code{font-size:14px;word-break:normal;white-space:pre;border:0;max-height:200px}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body pre{word-wrap:normal}.markdown-body pre code{word-wrap:normal;border:0}.markdown-body pre code:after,.markdown-body pre code:before{content:normal}.markdown-body .highlight .il,.markdown-body .highlight .m,.markdown-body .highlight .mf,.markdown-body .highlight .mh,.markdown-body .highlight .mi,.markdown-body .highlight .mo{color:#945277}.markdown-body .highlight .s,.markdown-body .highlight .s1,.markdown-body .highlight .s2,.markdown-body .highlight .sb,.markdown-body .highlight .sc,.markdown-body .highlight .sd,.markdown-body .highlight .se,.markdown-body .highlight .sh,.markdown-body .highlight .si,.markdown-body .highlight .sx{color:#df5000}.markdown-body .highlight .k,.markdown-body .highlight .kc,.markdown-body .highlight .kd,.markdown-body .highlight .kn,.markdown-body .highlight .kp,.markdown-body .highlight .kr,.markdown-body .highlight .kt,.markdown-body .highlight .o{font-weight:700}.markdown-body .highlight .kt{color:#458}.markdown-body .highlight .c,.markdown-body .highlight .c1,.markdown-body .highlight .cm{color:#998;font-style:italic}.markdown-body .highlight .cp,.markdown-body .highlight .cs{color:#999;font-weight:700}.markdown-body .highlight .cs{font-style:italic}.markdown-body .highlight .n{color:#4c4c4c}.markdown-body .highlight .na,.markdown-body .highlight .nv,.markdown-body .highlight .vc,.markdown-body .highlight .vg,.markdown-body .highlight .vi{color:teal}.markdown-body .highlight .nb{color:#0086b3}.markdown-body .highlight .nc{color:#458;font-weight:700}.markdown-body .highlight .no{color:#094e99}.markdown-body .highlight .ni{color:purple}.markdown-body .highlight .ne{color:#900;font-weight:700}.markdown-body .highlight .nf{color:#945277;font-weight:700}.markdown-body .highlight .nn{color:#555}.markdown-body .highlight .nt{color:navy}.markdown-body .highlight .err{color:#a61717;background-color:#e3d2d2}.markdown-body .highlight .gd{color:#000;background-color:#fdd}.markdown-body .highlight .gd .x{color:#000;background-color:#faa}.markdown-body .highlight .ge{font-style:italic}.markdown-body .highlight .gr{color:#a00}.markdown-body .highlight .gh{color:#999}.markdown-body .highlight .gi{color:#000;background-color:#dfd}.markdown-body .highlight .gi .x{color:#000;background-color:#afa}.markdown-body .highlight .go{color:#888}.markdown-body .highlight .gp{color:#555}.markdown-body .highlight .gs{font-weight:700}.markdown-body .highlight .gu{color:purple;font-weight:700}.markdown-body .highlight .gt{color:#a00}.markdown-body .highlight .ow{font-weight:700}.markdown-body .highlight .w{color:#bbb}.markdown-body .highlight .sr{color:#017936}.markdown-body .highlight .ss{color:#8b467f}.markdown-body .highlight .bp{color:#999}.markdown-body .highlight .gc{color:#999;background-color:#eaf2f5}.markdown-body .octicon{font:normal normal 16px octicons-anchor;line-height:1;display:inline-block;text-decoration:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .octicon-link:before{content:"\F05C"}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{float:left;margin:.3em 0 .25em -1.6em;vertical-align:middle}html{top:0;position:fixed}body,html{width:100%;height:100%}body{position:absolute;margin:0;font-family:-apple-system,Helvetica Neue,Helvetica,Segoe UI,Arial,freesans,sans-serif;color:#373737}.indie-flow-text{font-family:Indie Flower,Helvetica Neue}.game-text{font-family:Press Start\ 2P,Helvetica Neue}.container{position:absolute;width:100%;bottom:0;left:0;top:0;overflow:auto;-webkit-overflow-scrolling:touch}.container.with-header{top:50px}.posts-list{margin:20px auto;max-width:1000px;padding:0 40px}.posts-list .post-item{margin-bottom:30px}.posts-list .post-item .post-item-title{line-height:40px;font-size:28px}.posts-list .post-item .post-item-title a{color:inherit;text-decoration:none}.posts-list .post-item .post-item-base-info{line-height:30px;color:#afbd20;font-size:13px}.posts-list .post-item .post-item-desc{font-size:15px}.post-container{max-width:1000px;margin:0 auto;padding:0 20px}.post-container .post-title{font-size:30px}.post-container .post-date{margin-left:10px;color:#afbd20}.post-container .post-tag{color:rgba(82,162,96,.6)}.post-container .post-tag a{margin-left:10px;color:inherit;text-decoration:none}.post-container .post-tag a:hover{color:#52a260}.post-container .markdown-body{margin-top:30px}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.mashroom-item{border-radius:5px;margin:.5px;float:left;width:40px;height:40px;background-color:rgba(253,209,14,.6);animation:rotateplane 10s infinite ease-in-out}.mashroom-item.deep{background-color:rgba(253,209,14,.7)}.mashroom-item.blank{animation:none;background:none}@keyframes rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}10%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0)}60%{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}to{transform:perspective(120px) rotateX(-1turn) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-1turn) rotateY(0deg)}}.home-page-container{background:#52a260;position:absolute;left:0;top:0;width:100%;height:100%}.home-page{text-align:center;color:#fff;box-sizing:border-box;overflow:hidden}.home-page .home-title{font-size:35px;margin-bottom:50px}.home-page .mashroom-container{width:328px;margin:0 auto;position:relative;overflow:hidden}.home-page .operations{margin-top:30px}.home-page .operations a{color:#fff;text-decoration:none;margin:0 20px}</style></head><body><div id="___gatsby"><div data-reactroot=""><div class="header"><div class="header-title-container"><div class="header-logo"></div><div class="header-title game-text"><a href="/">Century&#x27;s world</a></div></div><div class="header-line-item game-text header-link"><a href="/">Posts</a></div></div><div class="container with-header"><div class="post-container"><div class="post-title">静心打磨手中利刃之从Ghost到Passport</div><div class="extra-info"><span class="post-date">22 October, 2017</span><span class="post-tag"><a href="/posts/静心打磨手中利刃">静心打磨手中利刃</a><a href="/posts/node">node</a></span></div><div class="markdown-body"><div><blockquote>
<p>其实一直有接触<a href="https://github.com/TryGhost/Ghost">Ghost</a>这个博客系统，自从学习node开始，就有使用过这个系统，乃至现在公司的博客系统，都是使用这个搭建的，曾经没有好好的去看看源码。最近想要修改这个系统的后台系统，但是<a href="https://github.com/TryGhost/Ghost-Admin">Ghost-Admin</a>的代码编译恕在下无能，真的有点难编译，或者可能就算编译通过了，也会比较难适应，于是就心生一个念头，自己写个<a href="https://github.com/guoshencheng/ghost-admin-react">ghost-admin-react</a>，当然随之而来的就是这个这个后台系统的登录问题，虽然我们从原始后台系统的登录就可以了解这个系统的登录了，但是我们不妨一窥Ghost的登录源码，或许能有些惊喜。</p>
</blockquote>
<h3>Ghost里面的接口登录校验</h3>
<p>既然是接口的登录校验，那我们就直蹦<code class="language-text">core/server/routes/api.js</code>的代码，我们会发现，这个Router在刚开始就声明了两种auth的中间件处理队列</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// no auth</span>
<span class="token keyword">var</span> authenticatePublic <span class="token operator">=</span> <span class="token punctuation">[</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>authenticateClient<span class="token punctuation">,</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>authenticateUser<span class="token punctuation">,</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>requiresAuthorizedUserPublicAPI
<span class="token punctuation">]</span>

<span class="token comment">// auth</span>
<span class="token comment">// Require user for private endpoints</span>
<span class="token keyword">var</span> authenticatePrivate <span class="token operator">=</span> <span class="token punctuation">[</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>authenticateClient<span class="token punctuation">,</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>authenticateUser<span class="token punctuation">,</span>
    middleware<span class="token punctuation">.</span>api<span class="token punctuation">.</span>requiresAuthorizedUser
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>从字面上就很容易理解，一个中间件是用于public的api的，一个中间件是用于private中间件的，那我们看一下<code class="language-text">auth.js</code>这个中间件的实现吧</p>
<h5>authenticateClient</h5>
<p>先看一下代码吧</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">  <span class="token keyword">function</span> <span class="token function">authenticateClient</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//假如 在头部含有 authorization: Bearer &lt;access_token>，进入到下个中间件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBearerAutorizationHeader</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 否则，视为登录的请求</span>
    <span class="token comment">//校验client_id 和 client_secret</span>
    <span class="token comment">//...此处省略若干行</span>
    <span class="token comment">//passport是一个用于处理请求校验的中间件, oauth2-client-password是一个校验client_id的passport中间件。</span>
    <span class="token keyword">return</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'oauth2-client-password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>session<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> failWithError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> origin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> error<span class="token punctuation">;</span>
        <span class="token comment">//处理错误 ...省略若干行代码</span>
        <span class="token comment">//取 origin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          origin <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">.</span>hostname<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// passport 的策略处理中没有返回client的时候，报错, 此处省略该功能的若干行代码 if (!client || client.type !== 'ua') { ... } 如果是 ua 类型的 client直接进入下个中间件，关于client是怎么来的，我们后面会继续讲</span>
        <span class="token comment">// 查看是否非有效的origin 如果有效，进入下个中间件，否则报错</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
      </div>
<p>这个中间件，首先是使用了<a href="https://github.com/jaredhanson/passport">passport</a>，我们将会在后面继续介绍这个优秀的请求校验相关的中间件。这个中间件主要用于登录和公开api的校验，因为私有的请求应该会在校验<code class="language-text">authorization: Bearer &lt;access_token&gt;</code>的时候就会进入下个中间件，所以我们在登录的时候，需要加入两个有效的client<em>id和client</em>secret的秘钥对，这个请求校验可以用于像很多的开放平台拥有一个publicKey和privateKey秘钥对的需求。</p>
<h5>authenticateUser</h5>
<p>老样子吧，我们先看代码，(<em>^__^</em>) 嘻嘻……</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">authenticateUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 熟悉的味道，使用了passport, 使用了passport-http-bearer的passport插件，用于校验 你使用的 access_token是否符合bearer规则</span>
  <span class="token keyword">return</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'bearer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>session<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> failWithError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理错误，省略若干代码</span>
      <span class="token comment">// 校验 user，并带入到接下来的中间件中，否则报错</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>authInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 省略若干行代码</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这个中间件是用于处理所有需要auth的请求的校验，所以所有需要auth的请求都需要在header里面加上一个<code class="language-text">authorization: bearer &lt;access_token&gt;</code>，这样才能通过这个中间件的校验。</p>
<h5>requiresAuthorizedUser &#x26; requiresAuthorizedUserPublicAPI</h5>
<p>Ghost提供一个测试的选项，可以公开一些api，在这个选项打开的时候，我们可以访问一些接口，在这个选项没有打开的时候，<code class="language-text">requiresAuthorizedUserPublicAPI</code>中间件等同于<code class="language-text">requiresAuthorizedUser</code>，所以<code class="language-text">authenticatePublic</code>也会等同于<code class="language-text">authenticatePrivate</code>。</p>
<h5>小小总结一下</h5>
<p>我们现在看完了这个auth的middleware，主要校验两个，一个是头部的authorization，一个是client<em>secre和client</em>id，主要用了一个passport的中间件，这个中间件非常灵活，可以使用很多的插件。关于这个passport的预处理，我们可以从<code class="language-text">auth-strategies.js</code>中找到，代码先不上了，比较无聊，就是从数据库中查询相应的数据并返回。</p>
<p>Ghost是一个比较古老的系统，以至于这个系统是需要node4来跑的，但是它从很早就开始使用了passport这个灵活的中间件，使用至今，passport仍然在发展，可见passport除了是一个非常优秀的中间件之外，还是一种非常好的设计模式，分离出了请求校验的这个模块，非常灵活。那么接下来，我们来了解一下这个中间件</p>
<h3>passport</h3>
<blockquote>
<p>上述的Ghost只是一个引子，引出的主要是今天的主角<a href="https://github.com/jaredhanson/passport">passport</a>, passport是个处理请求的权限校验的中间件，是一个非常灵活的中间件，在express灵活的中间件系统中，独立了整个请求校验模块，使用插件的形式处理各种情况的校验。</p>
</blockquote>
<p>我们可以先看入口文件，emmm... 都是一些输出的代码，很无聊，我们直接开始看<code class="language-text">authenticator.js</code>，这个文件输出的模块就是我们使用的<code class="language-text">passport</code>。</p>
<h5>authenticator</h5>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_key <span class="token operator">=</span> <span class="token string">'passport'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_strategies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_serializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_deserializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_infoTransformers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_framework <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_userProperty <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>构造方法，无聊，初始化了一些属性，更多的属性会在init()中被初始化，其中<code class="language-text">_userProperty</code>用于定义passport在作为中间件的时候在req注入的参数名</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">Authenticator<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">framework</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_framework <span class="token operator">=</span> fw<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Authenticator<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">framework</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./framework/connect'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deserializeUser<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serializeUser<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>这个<code class="language-text">init</code>需要关联三个模块，framework/connect模块，strategies/session.js模块，sessionManager模块，session.js我们先放一边，这是一个策略，当我们读了<code class="language-text">use</code>策略的代码之后，在回过头来看看这个代码，我们先来看看sessionManager这个模块</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">SessionManager<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">logIn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> user<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_serializeUser</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">[</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">]</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SessionManager<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">logOut</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>_passport <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>这个sessionManager的功能就和他的名字一样，是管理session中的user的，sessionManager分装了关于在session中添加用户信息和去除session中的用户信息的方法，我们可以知道passport的user信息是被存储在<code class="language-text">req.session._passport.user</code>中的，这里的logOut我觉得是有问题的，因为<code class="language-text">req.session._passport.user</code>并没有被删除。这也算是个不是特别有意思的模块。</p>
<p>相比之下framework/connect中的代码就很核心了。</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">exports <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span><span class="token function">__monkeypatchNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    initialize<span class="token punctuation">:</span> initialize<span class="token punctuation">,</span>
    authenticate<span class="token punctuation">:</span> authenticate
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">__monkeypatchNode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> IncomingMessageExt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../http/request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>login <span class="token operator">=</span>
  http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>logIn <span class="token operator">=</span> IncomingMessageExt<span class="token punctuation">.</span>logIn<span class="token punctuation">;</span>
  <span class="token comment">//...省略若干行代码</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p><code class="language-text">__monkeypatchNode</code>这种函数应该很熟悉了，在运行时给内置函数加上补丁。给<code class="language-text">http.IncomingMessage</code>加上了一些函数，req就是继承这个类的，这些函数定义在了<code class="language-text">http/request.js</code>中，差不多就是logIn和logOut，和sessionManager对应。将authenticate和initialize输出。我们先看看initialize</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span>passport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>_passport <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>instance <span class="token operator">=</span> passport<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>session<span class="token punctuation">[</span>passport<span class="token punctuation">.</span>_key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// load data from existing session</span>
      req<span class="token punctuation">.</span>_passport<span class="token punctuation">.</span>session <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">[</span>passport<span class="token punctuation">.</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>该函数的主要作用是输出一个中间件，中间件会在request进入服务器之后注入一些属性，这个函数会在passport.initialize中被输出，所以在应用中使用passport前先使用这个中间件<code class="language-text">app.use(passport.initialize())</code>，再来看看authenticate，这个函数会很长，开始的几行只是对参数做一下解析，解析出正确的参数，对不同的参数形式做一下兼容，之后返回了一个中间件，我们逐行来读一下这个<code class="language-text">function authenticate(req, res, next)</code></p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>logIn
    <span class="token operator">&amp;&amp;</span> http<span class="token punctuation">.</span>IncomingMessage<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>logIn <span class="token operator">!==</span> IncomingMessageExt<span class="token punctuation">.</span>logIn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../framework/connect'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">__monkeypatchNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>刚开始检查是否进行过monkeypatch，如果没有，先执行monkeypatch</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">allFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//定义一个失败的回调，</span>
  <span class="token comment">// 如果在定义中间件的时候，定义了回调，直接调用回调函数</span>
  <span class="token comment">// 如果没有定义回调会根据定义的参数进行设置并返回</span>
  <span class="token comment">// options.failureFlash 将错误信息放置到session的flash</span>
  <span class="token comment">// options.failureMessage 将错误的信息放到session.message</span>
  <span class="token comment">// options.failureRedirect 重定向到制定的地址,</span>
  <span class="token comment">// 如果没有定义failureRedirect 会直接返回错误</span>
<span class="token punctuation">}</span></code></pre>
      </div>
<p>以上定义了一个失败的回调函数，会在接下来的函数中被调用，接下来的函数是passport去尝试调用passport策略插件。attempt函数，代码会带上一些注释。可以跟着我一起读</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">attempt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> layer <span class="token operator">=</span> name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 当最后都取不到layer的时候，调用失败的回调。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">allFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 从策略的栈中获取到对应name的策略， 如果没有取到的话，报错</span>
  <span class="token keyword">var</span> prototype <span class="token operator">=</span> passport<span class="token punctuation">.</span><span class="token function">_strategy</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unknown authentication strategy "'</span> <span class="token operator">+</span> layer <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 获取到strategy，并定义一些必要的函数</span>
  <span class="token keyword">var</span> strategy <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  strategy<span class="token punctuation">.</span><span class="token function-variable function">success</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 策略成功的函数，太长了就省略一下，有兴趣的可以去看一下，大致讲解一下逻辑</span>
    <span class="token comment">// 如果定义了callback，执行callback</span>
    <span class="token comment">// 大致的和失败回调的很像，根据options的选项和失败的回调一样</span>
    <span class="token comment">// 执行req.logIn并根据选线重定向</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 在失败了之后将失败的一些信息加入到失败栈中，进入下一个循环</span>
  strategy<span class="token punctuation">.</span><span class="token function-variable function">fail</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>challenge<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> challenge <span class="token operator">==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      status <span class="token operator">=</span> challenge<span class="token punctuation">;</span>
      challenge <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    failures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> challenge<span class="token punctuation">:</span> challenge<span class="token punctuation">,</span> status<span class="token punctuation">:</span> status <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">attempt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 重定向</span>
  strategy<span class="token punctuation">.</span><span class="token function-variable function">redirect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> status <span class="token operator">||</span> <span class="token number">302</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过并继续下去</span>
  strategy<span class="token punctuation">.</span><span class="token function-variable function">pass</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 抛出异常</span>
  strategy<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 执行策略插件的authenticate方法</span>
  strategy<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// attempt</span></code></pre>
      </div>
<p>该函数主要是去循环的取的注册的策略插件，逐个的调用策略插件的<code class="language-text">authenticate</code>函数，在这个函数中，会调用上面注册的函数，从而返回、重定向或者继续循环。这是passport的中间件的核心代码，主要的功能是去循环注册的中间件，逐个通过authenticate处理，动态的将当前的对象作为参数，将方法注入到strategy，写的很通用很动态，这种写法也是在平时的代码编写中指的学习的。那么既然我们知道了策略插件的使用，那么我们现在可以来读一读session策略的代码了，也作为一个例子，看看是如何写策略的。</p>
<div class="gatsby-highlight" data-language="javascript">
      <pre class="language-javascript"><code class="language-javascript">SessionStrategy<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果没有使用过initialize，报错</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>_passport<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'passport.initialize() middleware not in use'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 省略若干代码</span>
  <span class="token comment">// su = req._passport.session.user: 看是否含有user</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>su <span class="token operator">||</span> su <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//解析user</span>
    <span class="token keyword">var</span> paused <span class="token operator">=</span> options<span class="token punctuation">.</span>pauseStream <span class="token operator">?</span> <span class="token function">pause</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_deserializeUser</span><span class="token punctuation">(</span>su<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略若干代码</span>
      self<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>paused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        paused<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
      </div>
<p>这个策略其实做的像是一个中间件，只调用了pass和error的参数，主要的功能在req中加入user其中user可以定义_userProperty来修改，我们要在应用开始的时候注册一下session的中间件，<code class="language-text">app.use(passport.session())</code></p>
<h3>总结</h3>
<p>这次的源码主要是passport这个模块，前面的Ghost主要是用来引出这个模块的。针对这个passport，很明显，贯穿全局的设计模式就和他里面的strategy名字一样，策略模式，这个模块提供了一个非常好的策略模式的实现方法，将除了除了策略的通用的方法抽离出来，将策略抽象出来，我们只要去实现特定的策略，然后在特定的地方使用特定的策略就可以了。这种方法减少了代码的冗余，梳清了代码的逻辑，把唯一可变的东西抽象了出来单独实现，是一种很好的设计模式。</p></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-3753e803ea1a9abe3edc.js","261085952541737":"component---src-pages-posts-js-cd1847220dc74c22455a.js","195351340454287":"component---src-templates-post-js-151fda6e99914a23c475.js","162898551421021":"component---src-pages-404-js-be0b53f9f29efb807651.js","35783957827783":"component---src-pages-index-js-75c9bfdbc5a000fa0746.js","60335399758886":"path----372f0b900649fbdd2150.js","52128937219153":"path---posts-静心打磨手中利刃-17ad9d900d78d587c2b4.js","155720654889932":"path---posts-node-a7f1f252c500bb49e88f.js","108919453860541":"path---posts-docker-f43dde7b4254d49ff2a3.js","216240011187204":"path---posts-promise-bfd9096e6b2d351edfde.js","252992580755484":"path---posts-es-e9e0d0dfe1ab32498f2e.js","34712125554247":"path---posts-react-4066d10a698b4ac15a58.js","146831492438712":"path---posts-redux-3b800fddaef8c2bcb6bd.js","188259988993670":"path---posts-webpack-eba839e869b614fc5d5f.js","155243275344959":"path---posts-wepy-88cf11c1a9cf9d0e8900.js","259481028934733":"path---posts-小程序-ca862660c157ecc02ca0.js","202390707485127":"path---posts-translate-9f484a4c22ae11e5f343.js","29362442043640":"path---posts-overreacted-fba7a511f007c07493b2.js","107370358937462":"path---posts-calm-to-polish-sword-express-fcbe0b2de030d6cc6c98.js","173402839352015":"path---posts-calm-to-polish-sword-ghost-to-passport-89e7ee61784af9f15ea5.js","162685832501665":"path---posts-docker-my-fontend-project-5eef77d637a9e4428a75.js","236054049938401":"path---posts-read-code-es-promise-polyfill-c056fe667c471ad927aa.js","270194815372944":"path---posts-read-react-redux-efaa77f3fc3f05a0d5b2.js","54342248932196":"path---posts-settle-react-es-6-119dbaf4693d20879a2f.js","164086441910093":"path---posts-shallow-into-wepy-source-code-598d7888a1449b7c2ba6.js","9756229565306":"path---posts-translate-overreacted-how-does-react-tell-a-class-from-a-function-1605e86aeffe6e303109.js","99838320125203":"path---posts-translate-overreacted-why-do-react-elements-have-typeof-property-46cb7284640e66747947.js","60536836248096":"path---posts-translate-overreacted-why-do-we-write-super-props-3df36ee661d4174f0651.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-a0e39f21c11f6a62c5ab.js","140933230050240":"path---posts-43545fcc515cf3574c68.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-5fa57a956833cc6431c9.js"}/*]]>*/</script><script>/*<![CDATA[*/["/commons-cf32f37b11eea4693204.js","/app-3753e803ea1a9abe3edc.js","/path---posts-calm-to-polish-sword-ghost-to-passport-89e7ee61784af9f15ea5.js","/component---src-templates-post-js-151fda6e99914a23c475.js","/component---src-layouts-index-js-5fa57a956833cc6431c9.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>